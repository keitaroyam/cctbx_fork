from __future__ import division
from libtbx.test_utils import approx_equal
import iotbx.ncs as ncs
import iotbx.pdb
import sys
import os

pdb_str_1 = """
CRYST1  399.000  399.000  399.000  90.00  90.00  90.00 P 1
ATOM      1  N   GLY A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CA  GLY A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   GLY A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  O   GLY A  34     127.304 211.628 173.503  1.00  0.00           O
TER
ATOM      5  N   GLY B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CA  GLY B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   GLY B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  O   GLY B  34     249.986 144.872 173.510  1.00  0.00           O
TER
ATOM      9  N   GLY C  34     189.583 273.076 175.423  1.00  0.00           N
ATOM     10  CA  GLY C  34     188.804 273.006 174.173  1.00  0.00           C
ATOM     11  C   GLY C  34     188.920 271.622 173.510  1.00  0.00           C
ATOM     12  O   GLY C  34     189.986 271.004 173.508  1.00  0.00           O
TER
"""

pdb_str_2 = """
CRYST1  399.000  399.000  399.000  90.00  90.00  90.00 P 1
ATOM      1  O   HOH S   1     109.583 203.076 175.423  1.00  0.00           O
TER
ATOM      1  N   GLY A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CA  GLY A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   GLY A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  O   GLY A  34     127.304 211.628 173.503  1.00  0.00           O
TER
ATOM      5  N   GLY B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CA  GLY B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   GLY B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  O   GLY B  34     249.986 144.872 173.510  1.00  0.00           O
TER
ATOM      9  N   GLY C  34     189.583 273.076 175.423  1.00  0.00           N
ATOM     10  CA  GLY C  34     188.804 273.006 174.173  1.00  0.00           C
ATOM     11  C   GLY C  34     188.920 271.622 173.510  1.00  0.00           C
ATOM     12  O   GLY C  34     189.986 271.004 173.508  1.00  0.00           O
TER
ATOM      9  O   TYR D   4     189.583 273.076 175.423  1.00  0.00           O
TER
"""

pdb_str_3 = """
CRYST1  399.000  399.000  399.000  90.00  90.00  90.00 P 1
ATOM      1  N   GLY A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CA  GLY A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   GLY A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  O   GLY A  34     127.304 211.628 173.503  1.00  0.00           O
TER
ATOM      5  N   GLY B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CA  GLY B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   GLY B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  O   GLY B  34     249.986 144.872 173.510  1.00  0.00           O
TER
ATOM      9  O   HOH C  34     189.583 273.076 175.423  1.00  0.00           O
ATOM     10  O   HOH C  34     188.804 273.006 174.173  1.00  0.00           O
ATOM     11  O   HOH C  34     188.920 271.622 173.510  1.00  0.00           O
ATOM     12  O   HOH C  34     189.986 271.004 173.508  1.00  0.00           O
TER
"""

pdb_str_4 = """
CRYST1  399.000  399.000  399.000  90.00  90.00  90.00 P 1
ATOM      1  N   GLY A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CA  GLY A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   GLY A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  O   GLY A  34     127.304 211.628 173.503  1.00  0.00           O
TER
ATOM      5  N   GLY B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CA  GLY B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   GLY B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  O   GLY B  34     249.986 144.872 173.510  1.00  0.00           O
TER
ATOM      9  N   TYR C  34     189.583 273.076 175.423  1.00  0.00           N
ATOM     10  CA  TYR C  34     188.804 273.006 174.173  1.00  0.00           C
ATOM     11  C   TYR C  34     188.920 271.622 173.510  1.00  0.00           C
ATOM     12  O   TYR C  34     189.986 271.004 173.508  1.00  0.00           O
TER
"""

pdb_str_5 = """
ATOM      1  N   MET A   1     158.070 173.095 147.115  1.00 50.00           N
ATOM      2  CA  MET A   1     157.408 172.627 148.359  1.00 50.00           C
ATOM      3  CB  MET A   1     157.550 171.094 148.516  1.00 50.00           C
ATOM      4  CG  MET A   1     156.748 170.503 149.691  1.00 50.00           C
ATOM      5  SD  MET A   1     154.968 170.855 149.612  1.00 50.00           S
ATOM      6  CE  MET A   1     154.505 169.913 151.091  1.00 50.00           C
ATOM      7  C   MET A   1     157.958 173.331 149.563  1.00 50.00           C
ATOM      8  O   MET A   1     157.196 173.814 150.399  1.00 50.00           O
TER
ATOM      9  N   MET B   1     174.781 155.306 150.054  1.00 50.00           N
ATOM     10  CA  MET B   1     174.332 154.630 151.298  1.00 50.00           C
ATOM     11  CB  MET B   1     175.016 153.251 151.453  1.00 50.00           C
ATOM     12  CG  MET B   1     174.481 152.410 152.628  1.00 50.00           C
ATOM     13  SD  MET B   1     172.693 152.099 152.550  1.00 50.00           S
ATOM     14  CE  MET B   1     172.601 151.052 154.028  1.00 50.00           C
ATOM     15  C   MET B   1     174.594 155.484 152.502  1.00 50.00           C
ATOM     16  O   MET B   1     173.710 155.660 153.339  1.00 50.00           O
TER
ATOM     17  N   MET C   1     148.867 195.697 144.146  1.00 50.00           N
ATOM     18  CA  MET C   1     148.080 195.499 145.390  1.00 50.00           C
ATOM     19  CB  MET C   1     147.662 194.018 145.549  1.00 50.00           C
ATOM     20  CG  MET C   1     146.701 193.755 146.723  1.00 50.00           C
ATOM     21  SD  MET C   1     145.166 194.723 146.643  1.00 50.00           S
ATOM     22  CE  MET C   1     144.395 194.012 148.122  1.00 50.00           C
ATOM     23  C   MET C   1     148.846 195.960 146.594  1.00 50.00           C
ATOM     24  O   MET C   1     148.308 196.685 147.429  1.00 50.00           O
TER
ATOM    417  N   MET 1   1     274.499 237.478  69.907  1.00 50.00           N
ATOM    418  CA  MET 1   1     275.223 237.861  71.146  1.00 50.00           C
ATOM    419  CB  MET 1   1     275.281 239.400  71.298  1.00 50.00           C
ATOM    420  CG  MET 1   1     276.159 239.886  72.466  1.00 50.00           C
ATOM    421  SD  MET 1   1     277.878 239.307  72.379  1.00 50.00           S
ATOM    422  CE  MET 1   1     278.468 240.186  73.852  1.00 50.00           C
ATOM    423  C   MET 1   1     274.593 237.238  72.356  1.00 50.00           C
ATOM    424  O   MET 1   1     275.291 236.663  73.190  1.00 50.00           O
TER
END
"""

pdb_str_6 = """\
CRYST1  577.812  448.715  468.790  90.00  90.00  90.00 P 1
ATOM      1  CA  LYS A 151      10.766   9.333  12.905  1.00 44.22           C
ATOM      2  CA  LYS A 152      10.117   9.159  11.610  1.00 49.42           C
ATOM      3  CA  LYS A 153       9.099   8.000  11.562  1.00 46.15           C
ATOM      4  CA  LYS A 154       8.000   8.202  11.065  1.00 52.97           C
ATOM      5  CA  LYS A 155      11.146   9.065  10.474  1.00 41.68           C
ATOM      6  CA  LYS A 156      10.547   9.007   9.084  1.00 55.55           C
TER
ATOM      7  CA  LYS B 157      11.545   9.413   8.000  1.00 72.27           C
ATOM      8  CA  LYS B 158      12.277  10.718   8.343  1.00 75.78           C
ATOM      9  CA  LYS B 159      11.349  11.791   8.809  1.00 75.88           C
TER
ATOM      7  CA  LYS F 157       2.154   3.953  16.298  1.00 72.27           C
ATOM      8  CA  LYS F 158       2.014   3.732  17.811  1.00 75.78           C
ATOM      9  CA  LYS F 159       2.558   2.413  18.250  1.00 75.88           C
TER
ATOM      7  CA  LYS D 157       4.334  10.965  12.119  1.00 72.27           C
ATOM      8  CA  LYS D 158       4.057  11.980  13.238  1.00 75.78           C
ATOM      9  CA  LYS D 159       3.177  11.427  14.310  1.00 75.88           C
TER
ATOM      1  CA  LYS C 151       6.855   8.667  15.730  1.00 44.22           C
ATOM      2  CA  LYS C 152       5.891   8.459  14.655  1.00 49.42           C
ATOM      3  CA  LYS C 153       6.103   7.155  13.858  1.00 46.15           C
ATOM      4  CA  LYS C 154       5.138   6.438  13.633  1.00 52.97           C
ATOM      5  CA  LYS C 155       5.801   9.685  13.736  1.00 41.68           C
ATOM      6  CA  LYS C 156       4.731   9.594  12.667  1.00 55.55           C
TER
ATOM      1  CA  LYS E 151       6.987   4.106  17.432  1.00 44.22           C
ATOM      2  CA  LYS E 152       6.017   3.539  16.502  1.00 49.42           C
ATOM      3  CA  LYS E 153       6.497   3.492  15.036  1.00 46.15           C
ATOM      4  CA  LYS E 154       6.348   2.458  14.400  1.00 52.97           C
ATOM      5  CA  LYS E 155       4.647   4.221  16.634  1.00 41.68           C
ATOM      6  CA  LYS E 156       3.552   3.605  15.788  1.00 55.55           C
TER
"""

pdb_str_7 = """\
CRYST1  577.812  448.715  468.790  90.00  90.00  90.00 P 1
ATOM      1  CA  LYS A 151      10.766   9.333  12.905  1.00 44.22           C
ATOM      2  CA  LYS A 152      10.117   9.159  11.610  1.00 49.42           C
ATOM      3  CA  LYS A 153       9.099   8.000  11.562  1.00 46.15           C
ATOM      4  CA  LYS A 154       8.000   8.202  11.065  1.00 52.97           C
ATOM      5  CA  LYS A 155      11.146   9.065  10.474  1.00 41.68           C
TER
ATOM    222  CA  LEU X  40      94.618  -5.253  91.582  1.00 87.10           C
ATOM    223  CA  ARG X  41      62.395  51.344  80.786  1.00107.25           C
ATOM    224  CA  ARG X  42      62.395  41.344  80.786  1.00107.25           C
TER
ATOM      1  CA  THR D   1       8.111  11.080  10.645  1.00 20.00           C
ATOM      2  CA  THR D   2       8.000   9.722  10.125  1.00 20.00           C
ATOM      3  CA  THR D   3       8.075   8.694  11.249  1.00 20.00           C
ATOM      4  CA  THR D   4       8.890   8.818  12.163  1.00 20.00           C
TER
ATOM      1  CA  LYS B 151       6.855   8.667  15.730  1.00 44.22           C
ATOM      2  CA  LYS B 152       5.891   8.459  14.655  1.00 49.42           C
ATOM      3  CA  LYS B 153       6.103   7.155  13.858  1.00 46.15           C
ATOM      4  CA  LYS B 154       5.138   6.438  13.633  1.00 52.97           C
ATOM      5  CA  LYS B 155       5.801   9.685  13.736  1.00 41.68           C
TER
ATOM      1  CA  LYS C 151       6.987   4.106  17.432  1.00 44.22           C
ATOM      2  CA  LYS C 152       6.017   3.539  16.502  1.00 49.42           C
ATOM      3  CA  LYS C 153       6.497   3.492  15.036  1.00 46.15           C
ATOM      4  CA  LYS C 154       6.348   2.458  14.400  1.00 52.97           C
ATOM      5  CA  LYS C 155       4.647   4.221  16.634  1.00 41.68           C
TER
ATOM    222  CA  LEU Y  40     194.618   5.253  81.582  1.00 87.10           C
ATOM    223  CA  ARG Y  41     162.395  41.344  70.786  1.00107.25           C
ATOM    224  CA  ARG Y  42     162.395  31.344  70.786  1.00107.25           C
TER
ATOM      1  CA  THR E   1       8.111 -10.645  11.080  1.00 20.00           C
ATOM      2  CA  THR E   2       8.000 -10.125   9.722  1.00 20.00           C
ATOM      3  CA  THR E   3       8.075 -11.249   8.694  1.00 20.00           C
ATOM      4  CA  THR E   4       8.890 -12.163   8.818  1.00 20.00           C
TER
"""

pdb_str_8 = """\
ATOM      1  N   THR A   1      13.014  18.419   8.520  1.00 20.00           N
ATOM      2  CA  THR A   1      12.903  17.061   8.000  1.00 20.00           C
ATOM      3  C   THR A   1      12.978  16.033   9.124  1.00 20.00           C
ATOM      4  O   THR A   1      13.793  16.157  10.038  1.00 20.00           O
TER
ATOM      1  N   THR C   1      10.325   8.000  14.368  1.00 20.00           N
ATOM      2  CA  THR C   1      10.111   8.702  13.108  1.00 20.00           C
ATOM      3  C   THR C   1      11.313   9.570  12.750  1.00 20.00           C
ATOM      4  O   THR C   1      11.885  10.241  13.609  1.00 20.00           O
TER
ATOM      1  N   THR D   1      -0.430  15.458  18.495  1.00 20.00           N
ATOM      2  CA  THR D   1       0.086  15.020  17.204  1.00 20.00           C
ATOM      3  C   THR D   1       1.440  14.334  17.355  1.00 20.00           C
ATOM      4  O   THR D   1       2.297  14.791  18.111  1.00 20.00           O
TER
ATOM      1  N   THR E   1       1.895   8.366  19.752  1.00 20.00           N
ATOM      2  CA  THR E   1       1.682   9.068  18.491  1.00 20.00           C
ATOM      3  C   THR E   1       2.884   9.935  18.133  1.00 20.00           C
ATOM      4  O   THR E   1       3.455  10.606  18.993  1.00 20.00           O
TER
ATOM      1  N   THR F   1       8.346   7.308  15.936  1.00 20.00           N
ATOM      2  CA  THR F   1       7.054   7.796  15.467  1.00 20.00           C
ATOM      3  C   THR F   1       6.884   9.281  15.767  1.00 20.00           C
ATOM      4  O   THR F   1       7.237   9.751  16.849  1.00 20.00           O
TER
ATOM      1  N   THR G   1       0.609  -0.560  24.094  1.00 20.00           N
ATOM      2  CA  THR G   1       0.395   0.142  22.834  1.00 20.00           C
ATOM      3  C   THR G   1       1.598   1.009  22.476  1.00 20.00           C
ATOM      4  O   THR G   1       2.169   1.680  23.335  1.00 20.00           O
TER
ATOM      1  N   THR H   1       7.061  -1.617  20.279  1.00 20.00           N
ATOM      2  CA  THR H   1       5.768  -1.130  19.810  1.00 20.00           C
ATOM      3  C   THR H   1       5.599   0.356  20.109  1.00 20.00           C
ATOM      4  O   THR H   1       5.950   0.825  21.191  1.00 20.00           O
TER
ATOM      1  N   THR I   1       8.722   4.822  16.665  1.00 20.00           N
ATOM      2  CA  THR I   1       7.494   4.036  16.653  1.00 20.00           C
ATOM      3  C   THR I   1       6.628   4.350  17.868  1.00 20.00           C
ATOM      4  O   THR I   1       7.130   4.482  18.984  1.00 20.00           O
TER
ATOM      1  N   THR B   1       8.000  15.093  13.112  1.00 20.00           N
ATOM      2  CA  THR B   1       8.516  14.654  11.820  1.00 20.00           C
ATOM      3  C   THR B   1       9.870  13.968  11.972  1.00 20.00           C
ATOM      4  O   THR B   1      10.727  14.426  12.727  1.00 20.00           O
TER
"""

pdb_str_9 = """\
ATOM     45  N   PHEAa   6     221.693 146.930 114.416  1.00 50.00           N
ATOM     46  CA  PHEAa   6     220.871 148.020 114.886  1.00 50.00           C
ATOM     47  C   PHEAa   6     219.413 147.628 114.926  1.00 50.00           C
ATOM     48  O   PHEAa   6     218.730 147.905 115.908  1.00 50.00           O
ATOM     49  CB  PHEAa   6     221.058 149.265 113.976  1.00 50.00           C
ATOM     50  CG  PHEAa   6     220.338 150.481 114.498  1.00 50.00           C
ATOM     51  CD1 PHEAa   6     220.740 151.082 115.702  1.00 50.00           C
ATOM     52  CD2 PHEAa   6     219.240 151.016 113.801  1.00 50.00           C
ATOM     53  CE1 PHEAa   6     220.059 152.198 116.204  1.00 50.00           C
ATOM     54  CE2 PHEAa   6     218.557 152.133 114.299  1.00 50.00           C
ATOM     55  CZ  PHEAa   6     218.965 152.723 115.500  1.00 50.00           C
ATOM     56  N   ASNAa   7     218.926 146.940 113.868  1.00 50.00           N
ATOM     57  CA  ASNAa   7     217.565 146.462 113.741  1.00 50.00           C
ATOM     58  C   ASNAa   7     217.229 145.425 114.782  1.00 50.00           C
ATOM     59  O   ASNAa   7     216.113 145.412 115.283  1.00 50.00           O
ATOM     60  CB  ASNAa   7     217.235 145.875 112.347  1.00 50.00           C
ATOM     61  CG  ASNAa   7     217.277 146.970 111.271  1.00 50.00           C
ATOM     62  OD1 ASNAa   7     217.061 148.155 111.550  1.00 50.00           O
ATOM     63  ND2 ASNAa   7     217.551 146.541 110.002  1.00 50.00           N
ATOM     64  N   LEUAa   8     218.185 144.528 115.129  1.00 50.00           N
ATOM     65  CA  LEUAa   8     217.998 143.485 116.117  1.00 50.00           C
ATOM     66  C   LEUAa   8     217.846 144.051 117.505  1.00 50.00           C
ATOM     67  O   LEUAa   8     217.002 143.585 118.265  1.00 50.00           O
ATOM     68  CB  LEUAa   8     219.168 142.476 116.143  1.00 50.00           C
ATOM     69  CG  LEUAa   8     219.217 141.553 114.906  1.00 50.00           C
ATOM     70  CD1 LEUAa   8     220.600 140.889 114.770  1.00 50.00           C
ATOM     71  CD2 LEUAa   8     218.098 140.493 114.925  1.00 50.00           C
ATOM     72  N   LYSAa   9     218.665 145.069 117.866  1.00 50.00           N
ATOM     73  CA  LYSAa   9     218.573 145.769 119.133  1.00 50.00           C
ATOM     74  C   LYSAa   9     217.287 146.554 119.234  1.00 50.00           C
ATOM     75  O   LYSAa   9     216.682 146.606 120.301  1.00 50.00           O
ATOM     76  CB  LYSAa   9     219.751 146.744 119.364  1.00 50.00           C
ATOM     77  CG  LYSAa   9     221.113 146.057 119.558  1.00 50.00           C
ATOM     78  CD  LYSAa   9     221.257 145.305 120.891  1.00 50.00           C
ATOM     79  CE  LYSAa   9     222.646 144.673 121.065  1.00 50.00           C
ATOM     80  NZ  LYSAa   9     222.723 143.882 122.315  1.00 50.00           N
TER
ATOM   1244  N   PHEAb   1     305.367 162.705 105.239  1.00 50.00           N
ATOM   1245  CA  PHEAb   1     304.396 162.991 106.331  1.00 50.00           C
ATOM   1246  C   PHEAb   1     304.285 164.473 106.586  1.00 50.00           C
ATOM   1247  O   PHEAb   1     304.837 165.292 105.851  1.00 50.00           O
ATOM   1248  CB  PHEAb   1     304.743 162.176 107.627  1.00 50.00           C
ATOM   1249  CG  PHEAb   1     305.801 162.775 108.540  1.00 50.00           C
ATOM   1250  CD1 PHEAb   1     307.055 163.195 108.061  1.00 50.00           C
ATOM   1251  CD2 PHEAb   1     305.501 162.973 109.900  1.00 50.00           C
ATOM   1252  CE1 PHEAb   1     307.967 163.838 108.909  1.00 50.00           C
ATOM   1253  CE2 PHEAb   1     306.412 163.612 110.751  1.00 50.00           C
ATOM   1254  CZ  PHEAb   1     307.642 164.054 110.251  1.00 50.00           C
ATOM   1255  N   LYSAb   2     303.607 164.838 107.696  1.00 50.00           N
ATOM   1256  CA  LYSAb   2     303.542 166.190 108.180  1.00 50.00           C
ATOM   1257  C   LYSAb   2     303.642 166.054 109.667  1.00 50.00           C
ATOM   1258  O   LYSAb   2     302.934 165.255 110.277  1.00 50.00           O
ATOM   1259  CB  LYSAb   2     302.234 166.947 107.855  1.00 50.00           C
ATOM   1260  CG  LYSAb   2     302.035 167.201 106.352  1.00 50.00           C
ATOM   1261  CD  LYSAb   2     300.842 168.117 106.023  1.00 50.00           C
ATOM   1262  CE  LYSAb   2     301.067 169.582 106.424  1.00 50.00           C
ATOM   1263  NZ  LYSAb   2     299.910 170.421 106.031  1.00 50.00           N
ATOM   1264  N   ALAAb   3     304.533 166.867 110.282  1.00 50.00           N
ATOM   1265  CA  ALAAb   3     304.840 166.840 111.692  1.00 50.00           C
ATOM   1266  C   ALAAb   3     303.670 167.320 112.503  1.00 50.00           C
ATOM   1267  O   ALAAb   3     303.399 166.803 113.583  1.00 50.00           O
ATOM   1268  CB  ALAAb   3     306.055 167.711 112.038  1.00 50.00           C
ATOM   1269  N   GLUAb   4     302.961 168.344 111.975  1.00 50.00           N
ATOM   1270  CA  GLUAb   4     301.784 168.942 112.560  1.00 50.00           C
ATOM   1271  C   GLUAb   4     300.678 167.941 112.768  1.00 50.00           C
ATOM   1272  O   GLUAb   4     300.094 167.886 113.848  1.00 50.00           O
ATOM   1273  CB  GLUAb   4     301.233 170.108 111.709  1.00 50.00           C
ATOM   1274  CG  GLUAb   4     302.268 171.215 111.421  1.00 50.00           C
ATOM   1275  CD  GLUAb   4     302.808 171.795 112.727  1.00 50.00           C
ATOM   1276  OE1 GLUAb   4     304.040 171.677 112.965  1.00 50.00           O
ATOM   1277  OE2 GLUAb   4     301.994 172.363 113.504  1.00 50.00           O
TER
ATOM   2754  N   PHEAc   6     244.472 153.067 117.352  1.00 50.00           N
ATOM   2755  CA  PHEAc   6     243.314 153.789 117.823  1.00 50.00           C
ATOM   2756  C   PHEAc   6     242.094 152.900 117.864  1.00 50.00           C
ATOM   2757  O   PHEAc   6     241.358 152.912 118.847  1.00 50.00           O
ATOM   2758  CB  PHEAc   6     243.040 155.017 116.913  1.00 50.00           C
ATOM   2759  CG  PHEAc   6     241.932 155.894 117.436  1.00 50.00           C
ATOM   2760  CD1 PHEAc   6     242.091 156.600 118.639  1.00 50.00           C
ATOM   2761  CD2 PHEAc   6     240.715 155.999 116.739  1.00 50.00           C
ATOM   2762  CE1 PHEAc   6     241.055 157.396 119.141  1.00 50.00           C
ATOM   2763  CE2 PHEAc   6     239.676 156.795 117.237  1.00 50.00           C
ATOM   2764  CZ  PHEAc   6     239.846 157.493 118.439  1.00 50.00           C
ATOM   2765  N   ASNAc   7     241.886 152.082 116.806  1.00 50.00           N
ATOM   2766  CA  ASNAc   7     240.788 151.148 116.680  1.00 50.00           C
ATOM   2767  C   ASNAc   7     240.847 150.058 117.721  1.00 50.00           C
ATOM   2768  O   ASNAc   7     239.810 149.645 118.224  1.00 50.00           O
ATOM   2769  CB  ASNAc   7     240.690 150.481 115.286  1.00 50.00           C
ATOM   2770  CG  ASNAc   7     240.334 151.517 114.210  1.00 50.00           C
ATOM   2771  OD1 ASNAc   7     239.707 152.544 114.490  1.00 50.00           O
ATOM   2772  ND2 ASNAc   7     240.743 151.215 112.941  1.00 50.00           N
ATOM   2773  N   LEUAc   8     242.062 149.565 118.068  1.00 50.00           N
ATOM   2774  CA  LEUAc   8     242.264 148.525 119.056  1.00 50.00           C
ATOM   2775  C   LEUAc   8     241.919 148.999 120.443  1.00 50.00           C
ATOM   2776  O   LEUAc   8     241.299 148.260 121.204  1.00 50.00           O
ATOM   2777  CB  LEUAc   8     243.717 148.003 119.082  1.00 50.00           C
ATOM   2778  CG  LEUAc   8     244.094 147.160 117.844  1.00 50.00           C
ATOM   2779  CD1 LEUAc   8     245.623 147.037 117.707  1.00 50.00           C
ATOM   2780  CD2 LEUAc   8     243.430 145.768 117.864  1.00 50.00           C
ATOM   2781  N   LYSAc   9     242.317 150.242 120.804  1.00 50.00           N
ATOM   2782  CA  LYSAc   9     241.981 150.863 122.071  1.00 50.00           C
ATOM   2783  C   LYSAc   9     240.499 151.134 122.173  1.00 50.00           C
ATOM   2784  O   LYSAc   9     239.916 150.965 123.241  1.00 50.00           O
ATOM   2785  CB  LYSAc   9     242.729 152.197 122.302  1.00 50.00           C
ATOM   2786  CG  LYSAc   9     244.248 152.045 122.495  1.00 50.00           C
ATOM   2787  CD  LYSAc   9     244.653 151.394 123.828  1.00 50.00           C
ATOM   2788  CE  LYSAc   9     246.177 151.304 124.001  1.00 50.00           C
ATOM   2789  NZ  LYSAc   9     246.534 150.594 125.250  1.00 50.00           N
TER
ATOM   3953  N   PHEAd   1     316.882 197.854 108.123  1.00 50.00           N
ATOM   3954  CA  PHEAd   1     315.875 197.773 109.215  1.00 50.00           C
ATOM   3955  C   PHEAd   1     315.239 199.116 109.471  1.00 50.00           C
ATOM   3956  O   PHEAd   1     315.460 200.078 108.736  1.00 50.00           O
ATOM   3957  CB  PHEAd   1     316.493 197.136 110.512  1.00 50.00           C
ATOM   3958  CG  PHEAd   1     317.265 198.076 111.424  1.00 50.00           C
ATOM   3959  CD1 PHEAd   1     318.283 198.919 110.944  1.00 50.00           C
ATOM   3960  CD2 PHEAd   1     316.915 198.154 112.784  1.00 50.00           C
ATOM   3961  CE1 PHEAd   1     318.905 199.846 111.792  1.00 50.00           C
ATOM   3962  CE2 PHEAd   1     317.536 199.077 113.635  1.00 50.00           C
ATOM   3963  CZ  PHEAd   1     318.525 199.932 113.135  1.00 50.00           C
ATOM   3964  N   LYSAd   2     314.475 199.212 110.581  1.00 50.00           N
ATOM   3965  CA  LYSAd   2     313.929 200.450 111.066  1.00 50.00           C
ATOM   3966  C   LYSAd   2     314.073 200.360 112.553  1.00 50.00           C
ATOM   3967  O   LYSAd   2     313.699 199.360 113.163  1.00 50.00           O
ATOM   3968  CB  LYSAd   2     312.437 200.687 110.742  1.00 50.00           C
ATOM   3969  CG  LYSAd   2     312.159 200.852 109.239  1.00 50.00           C
ATOM   3970  CD  LYSAd   2     310.717 201.278 108.910  1.00 50.00           C
ATOM   3971  CE  LYSAd   2     310.400 202.726 109.311  1.00 50.00           C
ATOM   3972  NZ  LYSAd   2     309.019 203.094 108.919  1.00 50.00           N
ATOM   3973  N   ALAAd   3     314.612 201.440 113.166  1.00 50.00           N
ATOM   3974  CA  ALAAd   3     314.909 201.525 114.577  1.00 50.00           C
ATOM   3975  C   ALAAd   3     313.646 201.552 115.389  1.00 50.00           C
ATOM   3976  O   ALAAd   3     313.579 200.972 116.469  1.00 50.00           O
ATOM   3977  CB  ALAAd   3     315.731 202.774 114.922  1.00 50.00           C
ATOM   3978  N   GLUAd   4     312.615 202.253 114.862  1.00 50.00           N
ATOM   3979  CA  GLUAd   4     311.303 202.387 115.448  1.00 50.00           C
ATOM   3980  C   GLUAd   4     310.630 201.057 115.656  1.00 50.00           C
ATOM   3981  O   GLUAd   4     310.105 200.796 116.737  1.00 50.00           O
ATOM   3982  CB  GLUAd   4     310.369 203.279 114.597  1.00 50.00           C
ATOM   3983  CG  GLUAd   4     310.938 204.683 114.308  1.00 50.00           C
ATOM   3984  CD  GLUAd   4     311.233 205.418 115.614  1.00 50.00           C
ATOM   3985  OE1 GLUAd   4     312.425 205.752 115.850  1.00 50.00           O
ATOM   3986  OE2 GLUAd   4     310.271 205.657 116.392  1.00 50.00           O
TER
END
"""

pdb_str_10 = """\
ATOM    181  CA  SER L  26      43.792 -65.179  67.649  1.00 22.76           C
ATOM    182  C   SER L  26      43.921 -63.740  68.152  1.00 25.79           C
ATOM    183  O   SER L  26      44.600 -63.476  69.148  1.00 27.95           O
ATOM    184  CB  SER L  26      45.023 -65.575  66.834  1.00 23.39           C
ATOM    185  OG  SER L  26      45.013 -64.937  65.570  1.00 21.58           O
ATOM    186  N   GLN L  27      43.266 -62.813  67.460  1.00 23.64           N
ATOM    187  CA  GLN L  27      43.289 -61.405  67.832  1.00 24.84           C
ATOM    188  C   GLN L  27      41.869 -60.863  67.858  1.00 25.95           C
ATOM    189  O   GLN L  27      40.987 -61.380  67.172  1.00 26.41           O
ATOM    190  CB  GLN L  27      44.108 -60.589  66.830  1.00 27.09           C
ATOM    191  CG  GLN L  27      45.602 -60.618  67.048  1.00 35.67           C
ATOM    192  CD  GLN L  27      46.338 -59.767  66.033  1.00 38.53           C
ATOM    193  OE1 GLN L  27      46.675 -60.228  64.942  1.00 43.32           O
ATOM    194  NE2 GLN L  27      46.572 -58.507  66.380  1.00 40.19           N
ATOM    195  N   SER L  27A     41.653 -59.819  68.651  1.00 21.30           N
ATOM    196  CA  SER L  27A     40.340 -59.209  68.744  1.00 23.38           C
ATOM    197  C   SER L  27A     39.920 -58.676  67.377  1.00 22.05           C
ATOM    198  O   SER L  27A     40.712 -58.050  66.678  1.00 19.83           O
ATOM    199  CB  SER L  27A     40.362 -58.057  69.745  1.00 20.17           C
ATOM    200  OG  SER L  27A     39.122 -57.376  69.738  1.00 24.39           O
ATOM    201  N   LEU L  27B     38.669 -58.918  67.003  1.00 21.73           N
ATOM    202  CA  LEU L  27B     38.173 -58.446  65.720  1.00 20.41           C
ATOM    203  C   LEU L  27B     37.484 -57.089  65.854  1.00 21.13           C
ATOM    204  O   LEU L  27B     36.749 -56.670  64.961  1.00 21.34           O
ATOM    205  CB  LEU L  27B     37.212 -59.473  65.116  1.00 17.54           C
ATOM    206  CG  LEU L  27B     37.805 -60.882  64.938  1.00 21.70           C
ATOM    207  CD1 LEU L  27B     36.800 -61.778  64.232  1.00 19.78           C
ATOM    208  CD2 LEU L  27B     39.092 -60.808  64.132  1.00 17.87           C
ATOM    235  N   ASN L  28      36.659 -48.175  64.751  1.00 23.50           N
ATOM    236  CA  ASN L  28      35.418 -47.408  64.733  1.00 19.92           C
ATOM    237  C   ASN L  28      34.411 -48.040  65.685  1.00 22.34           C
ATOM    238  O   ASN L  28      33.274 -47.586  65.794  1.00 25.95           O
ATOM    239  CB  ASN L  28      34.831 -47.338  63.321  1.00 19.19           C
ATOM    240  CG  ASN L  28      34.676 -48.707  62.680  1.00 22.32           C
ATOM    241  OD1 ASN L  28      34.703 -49.732  63.359  1.00 19.98           O
ATOM    242  ND2 ASN L  28      34.498 -48.726  61.364  1.00 21.69           N
ATOM    243  N   GLY L  29      34.835 -49.093  66.374  1.00 23.30           N
ATOM    244  CA  GLY L  29      33.957 -49.746  67.329  1.00 23.12           C
ATOM    245  C   GLY L  29      33.135 -50.912  66.810  1.00 25.74           C
ATOM    246  O   GLY L  29      32.347 -51.500  67.555  1.00 22.95           O
TER
ATOM      1  CA  SER H  26      46.792 -62.179  70.649  1.00 22.76           C
ATOM      2  C   SER H  26      46.921 -60.740  71.152  1.00 25.79           C
ATOM      3  O   SER H  26      47.600 -60.476  72.148  1.00 27.95           O
ATOM      4  CB  SER H  26      48.023 -62.575  69.834  1.00 23.39           C
ATOM      5  OG  SER H  26      48.013 -61.937  68.570  1.00 21.58           O
ATOM      6  N   GLN H  27      46.266 -59.813  70.460  1.00 23.64           N
ATOM      7  CA  GLN H  27      46.289 -58.405  70.832  1.00 24.84           C
ATOM      8  C   GLN H  27      44.869 -57.863  70.858  1.00 25.95           C
ATOM      9  O   GLN H  27      43.987 -58.380  70.172  1.00 26.41           O
ATOM     10  CB  GLN H  27      47.108 -57.589  69.830  1.00 27.09           C
ATOM     11  CG  GLN H  27      48.602 -57.618  70.048  1.00 35.67           C
ATOM     12  CD  GLN H  27      49.338 -56.767  69.033  1.00 38.53           C
ATOM     13  OE1 GLN H  27      49.675 -57.228  67.942  1.00 43.32           O
ATOM     14  NE2 GLN H  27      49.572 -55.507  69.380  1.00 40.19           N
ATOM     15  N   SER H  27A     44.653 -56.819  71.651  1.00 21.30           N
ATOM     16  CA  SER H  27A     43.340 -56.209  71.744  1.00 23.38           C
ATOM     17  C   SER H  27A     42.920 -55.676  70.377  1.00 22.05           C
ATOM     18  O   SER H  27A     43.712 -55.050  69.678  1.00 19.83           O
ATOM     19  CB  SER H  27A     43.362 -55.057  72.745  1.00 20.17           C
ATOM     20  OG  SER H  27A     42.122 -54.376  72.738  1.00 24.39           O
ATOM     21  N   LEU H  27B     41.669 -55.918  70.003  1.00 21.73           N
ATOM     22  CA  LEU H  27B     41.173 -55.446  68.720  1.00 20.41           C
ATOM     23  C   LEU H  27B     40.484 -54.089  68.854  1.00 21.13           C
ATOM     24  O   LEU H  27B     39.749 -53.670  67.961  1.00 21.34           O
ATOM     25  CB  LEU H  27B     40.212 -56.473  68.116  1.00 17.54           C
ATOM     26  CG  LEU H  27B     40.805 -57.882  67.938  1.00 21.70           C
ATOM     27  CD1 LEU H  27B     39.800 -58.778  67.232  1.00 19.78           C
ATOM     28  CD2 LEU H  27B     42.092 -57.808  67.132  1.00 17.87           C
ATOM     29  N   ASN H  28      39.659 -45.175  67.751  1.00 23.50           N
ATOM     30  CA  ASN H  28      38.418 -44.408  67.733  1.00 19.92           C
ATOM     31  C   ASN H  28      37.411 -45.040  68.685  1.00 22.34           C
ATOM     32  O   ASN H  28      36.274 -44.586  68.794  1.00 25.95           O
ATOM     33  CB  ASN H  28      37.831 -44.338  66.321  1.00 19.19           C
ATOM     34  CG  ASN H  28      37.676 -45.707  65.680  1.00 22.32           C
ATOM     35  OD1 ASN H  28      37.703 -46.732  66.359  1.00 19.98           O
ATOM     36  ND2 ASN H  28      37.498 -45.726  64.364  1.00 21.69           N
ATOM     37  N   GLY H  29      37.835 -46.093  69.374  1.00 23.30           N
ATOM     38  CA  GLY H  29      36.957 -46.746  70.329  1.00 23.12           C
ATOM     39  C   GLY H  29      36.135 -47.912  69.810  1.00 25.74           C
ATOM     40  O   GLY H  29      35.347 -48.500  70.555  1.00 22.95           O
"""

pdb_str_11 = """\
ATOM    181  CA  SER L  26      43.792 -65.179  67.649  1.00 22.76           C
ATOM    182  C   SER L  26      43.921 -63.740  68.152  1.00 25.79           C
ATOM    183  O   SER L  26      44.600 -63.476  69.148  1.00 27.95           O
ATOM    184  CB  SER L  26      45.023 -65.575  66.834  1.00 23.39           C
ATOM    185  OG  SER L  26      45.013 -64.937  65.570  1.00 21.58           O
ATOM    186  N  AGLN L  27      43.266 -62.813  67.460  0.50 23.64           N
ATOM    187  CA AGLN L  27      43.289 -61.405  67.832  0.50 24.84           C
ATOM    188  C  AGLN L  27      41.869 -60.863  67.858  0.50 25.95           C
ATOM    189  O  AGLN L  27      40.987 -61.380  67.172  0.50 26.41           O
ATOM    190  CB AGLN L  27      44.108 -60.589  66.830  0.50 27.09           C
ATOM    191  CG AGLN L  27      45.602 -60.618  67.048  0.50 35.67           C
ATOM    192  CD AGLN L  27      46.338 -59.767  66.033  0.50 38.53           C
ATOM    193  OE1AGLN L  27      46.675 -60.228  64.942  0.50 43.32           O
ATOM    194  NE2AGLN L  27      46.572 -58.507  66.380  0.50 40.19           N
ATOM    195  N  BSER L  27      41.653 -59.819  68.651  0.50 21.30           N
ATOM    196  CA BSER L  27      40.340 -59.209  68.744  0.50 23.38           C
ATOM    197  C  BSER L  27      39.920 -58.676  67.377  0.50 22.05           C
ATOM    198  O  BSER L  27      40.712 -58.050  66.678  0.50 19.83           O
ATOM    199  CB BSER L  27      40.362 -58.057  69.745  0.50 20.17           C
ATOM    200  OG BSER L  27      39.122 -57.376  69.738  0.50 24.39           O
ATOM    235  N   ASN L  28      36.659 -48.175  64.751  1.00 23.50           N
ATOM    236  CA  ASN L  28      35.418 -47.408  64.733  1.00 19.92           C
ATOM    237  C   ASN L  28      34.411 -48.040  65.685  1.00 22.34           C
ATOM    238  O   ASN L  28      33.274 -47.586  65.794  1.00 25.95           O
ATOM    239  CB  ASN L  28      34.831 -47.338  63.321  1.00 19.19           C
ATOM    240  CG  ASN L  28      34.676 -48.707  62.680  1.00 22.32           C
ATOM    241  OD1 ASN L  28      34.703 -49.732  63.359  1.00 19.98           O
ATOM    242  ND2 ASN L  28      34.498 -48.726  61.364  1.00 21.69           N
TER
ATOM      1  CA  SER H  26      46.792 -62.179  70.649  1.00 22.76           C
ATOM      2  C   SER H  26      46.921 -60.740  71.152  1.00 25.79           C
ATOM      3  O   SER H  26      47.600 -60.476  72.148  1.00 27.95           O
ATOM      4  CB  SER H  26      48.023 -62.575  69.834  1.00 23.39           C
ATOM      5  OG  SER H  26      48.013 -61.937  68.570  1.00 21.58           O
ATOM      6  N  AGLN H  27      46.266 -59.813  70.460  0.50 23.64           N
ATOM      7  CA AGLN H  27      46.289 -58.405  70.832  0.50 24.84           C
ATOM      8  C  AGLN H  27      44.869 -57.863  70.858  0.50 25.95           C
ATOM      9  O  AGLN H  27      43.987 -58.380  70.172  0.50 26.41           O
ATOM     10  CB AGLN H  27      47.108 -57.589  69.830  0.50 27.09           C
ATOM     11  CG AGLN H  27      48.602 -57.618  70.048  0.50 35.67           C
ATOM     12  CD AGLN H  27      49.338 -56.767  69.033  0.50 38.53           C
ATOM     13  OE1AGLN H  27      49.675 -57.228  67.942  0.50 43.32           O
ATOM     14  NE2AGLN H  27      49.572 -55.507  69.380  0.50 40.19           N
ATOM     15  N  BSER H  27      44.653 -56.819  71.651  0.50 21.30           N
ATOM     16  CA BSER H  27      43.340 -56.209  71.744  0.50 23.38           C
ATOM     17  C  BSER H  27      42.920 -55.676  70.377  0.50 22.05           C
ATOM     18  O  BSER H  27      43.712 -55.050  69.678  0.50 19.83           O
ATOM     19  CB BSER H  27      43.362 -55.057  72.745  0.50 20.17           C
ATOM     20  OG BSER H  27      42.122 -54.376  72.738  0.50 24.39           O
ATOM     29  N   ASN H  28      39.659 -45.175  67.751  1.00 23.50           N
ATOM     30  CA  ASN H  28      38.418 -44.408  67.733  1.00 19.92           C
ATOM     31  C   ASN H  28      37.411 -45.040  68.685  1.00 22.34           C
ATOM     32  O   ASN H  28      36.274 -44.586  68.794  1.00 25.95           O
ATOM     33  CB  ASN H  28      37.831 -44.338  66.321  1.00 19.19           C
ATOM     34  CG  ASN H  28      37.676 -45.707  65.680  1.00 22.32           C
ATOM     35  OD1 ASN H  28      37.703 -46.732  66.359  1.00 19.98           O
ATOM     36  ND2 ASN H  28      37.498 -45.726  64.364  1.00 21.69           N
"""

pdb_str_12 = """\
MODEL        1
ATOM    181  CA  SER L  26      43.792 -65.179  67.649  1.00 22.76           C
ATOM    182  C   SER L  26      43.921 -63.740  68.152  1.00 25.79           C
ATOM    183  O   SER L  26      44.600 -63.476  69.148  1.00 27.95           O
ATOM    184  CB  SER L  26      45.023 -65.575  66.834  1.00 23.39           C
ATOM    185  OG  SER L  26      45.013 -64.937  65.570  1.00 21.58           O
ATOM      1  CA  SER H  26      46.792 -62.179  70.649  1.00 22.76           C
ATOM      2  C   SER H  26      46.921 -60.740  71.152  1.00 25.79           C
ATOM      3  O   SER H  26      47.600 -60.476  72.148  1.00 27.95           O
ATOM      4  CB  SER H  26      48.023 -62.575  69.834  1.00 23.39           C
ATOM      5  OG  SER H  26      48.013 -61.937  68.570  1.00 21.58           O
ENDMDL
MODEL        2
ATOM    181  CA  SER L  26      43.792 -65.179  67.649  1.00 22.76           C
ATOM    182  C   SER L  26      43.921 -63.740  68.152  1.00 25.79           C
ATOM    183  O   SER L  26      44.600 -63.476  69.148  1.00 27.95           O
ATOM    184  CB  SER L  26      45.023 -65.575  66.834  1.00 23.39           C
ATOM    185  OG  SER L  26      45.013 -64.937  65.570  1.00 21.58           O
ATOM      1  CA  SER H  26      46.792 -62.179  70.649  1.00 22.76           C
ATOM      2  C   SER H  26      46.921 -60.740  71.152  1.00 25.79           C
ATOM      3  O   SER H  26      47.600 -60.476  72.148  1.00 27.95           O
ATOM      4  CB  SER H  26      48.023 -62.575  69.834  1.00 23.39           C
ATOM      5  OG  SER H  26      48.013 -61.937  68.570  1.00 21.58           O
ENDMDL
"""

pdb_str_13 = """\
ATOM      1  P    DG A 101      29.431  -7.266  16.571  1.00 20.00           P
ATOM      2  OP1  DG A 101      28.043  -6.752  16.549  1.00 20.00           O
ATOM      3  OP2  DG A 101      30.364  -6.133  16.806  1.00 20.00           O
ATOM      4  O5'  DG A 101      29.574  -8.346  17.739  1.00 20.00           O
ATOM      5  C5'  DG A 101      30.631  -9.289  17.729  1.00 20.00           C
ATOM      6  C4'  DG A 101      31.914  -8.737  18.342  1.00 20.00           C
ATOM      7  O4'  DG A 101      32.710  -7.950  17.421  1.00 20.00           O
ATOM      8  C3'  DG A 101      31.833  -7.757  19.494  1.00 20.00           C
ATOM      9  O3'  DG A 101      31.252  -8.345  20.643  1.00 20.00           O
ATOM     10  C2'  DG A 101      33.328  -7.516  19.649  1.00 20.00           C
ATOM     11  C1'  DG A 101      33.752  -7.367  18.191  1.00 20.00           C
ATOM     12  P    DA A 102      30.972  -7.472  21.954  1.00 20.00           P
ATOM     13  OP1  DA A 102      30.002  -8.227  22.777  1.00 20.00           O
ATOM     14  OP2  DA A 102      30.635  -6.106  21.501  1.00 20.00           O
ATOM     15  O5'  DA A 102      32.406  -7.509  22.679  1.00 20.00           O
ATOM     16  C5'  DA A 102      32.679  -7.422  24.091  1.00 20.00           C
ATOM     17  C4'  DA A 102      33.179  -6.028  24.456  1.00 20.00           C
ATOM     18  O4'  DA A 102      33.463  -5.302  23.221  1.00 20.00           O
ATOM     19  C3'  DA A 102      32.175  -5.184  25.252  1.00 20.00           C
ATOM     20  O3'  DA A 102      32.792  -4.407  26.338  1.00 20.00           O
ATOM     21  C2'  DA A 102      31.466  -4.398  24.138  1.00 20.00           C
ATOM     22  C1'  DA A 102      32.655  -4.152  23.209  1.00 20.00           C
TER
ATOM    298  P    DGaA 101      49.431  12.734  36.571  1.00 20.00           P
ATOM    299  OP1  DGaA 101      48.043  13.248  36.549  1.00 20.00           O
ATOM    300  OP2  DGaA 101      50.364  13.867  36.806  1.00 20.00           O
ATOM    301  O5'  DGaA 101      49.574  11.654  37.739  1.00 20.00           O
ATOM    302  C5'  DGaA 101      50.631  10.711  37.729  1.00 20.00           C
ATOM    303  C4'  DGaA 101      51.914  11.263  38.342  1.00 20.00           C
ATOM    304  O4'  DGaA 101      52.710  12.050  37.421  1.00 20.00           O
ATOM    305  C3'  DGaA 101      51.833  12.243  39.494  1.00 20.00           C
ATOM    306  O3'  DGaA 101      51.252  11.655  40.643  1.00 20.00           O
ATOM    307  C2'  DGaA 101      53.328  12.484  39.649  1.00 20.00           C
ATOM    308  C1'  DGaA 101      53.752  12.633  38.191  1.00 20.00           C
ATOM    309  P    DAaA 102      50.972  12.528  41.954  1.00 20.00           P
ATOM    310  OP1  DAaA 102      50.002  11.773  42.777  1.00 20.00           O
ATOM    311  OP2  DAaA 102      50.635  13.894  41.501  1.00 20.00           O
ATOM    312  O5'  DAaA 102      52.406  12.491  42.679  1.00 20.00           O
ATOM    313  C5'  DAaA 102      52.679  12.578  44.091  1.00 20.00           C
ATOM    314  C4'  DAaA 102      53.179  13.972  44.456  1.00 20.00           C
ATOM    315  O4'  DAaA 102      53.463  14.698  43.221  1.00 20.00           O
ATOM    316  C3'  DAaA 102      52.175  14.816  45.252  1.00 20.00           C
ATOM    317  O3'  DAaA 102      52.792  15.593  46.338  1.00 20.00           O
ATOM    318  C2'  DAaA 102      51.466  15.602  44.138  1.00 20.00           C
ATOM    319  C1'  DAaA 102      52.655  15.848  43.209  1.00 20.00           C
END
"""

pdb_str_14 = """
CRYST1  399.000  399.000  399.000  90.00  90.00  90.00 P 1
ATOM      1  N1  XXX A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CT  XXX A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   XXX A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  K   XXX A  34     127.304 211.628 173.503  1.00  0.00           K
TER
ATOM      5  N1  XXX B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CT  XXX B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   XXX B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  K   XXX B  34     249.986 144.872 173.510  1.00  0.00           K
TER
ATOM      9  N1  XXX C  34     189.583 273.076 175.423  1.00  0.00           N
ATOM     10  CT  XXX C  34     188.804 273.006 174.173  1.00  0.00           C
ATOM     11  C   XXX C  34     188.920 271.622 173.510  1.00  0.00           C
ATOM     12  K   XXX C  34     189.986 271.004 173.508  1.00  0.00           K
TER
"""

pdb_str_15 = """
ATOM      1  N1  XXX A  34     125.208 211.886 175.417  1.00  0.00           N
ATOM      2  CT  XXX A  34     125.035 211.123 174.168  1.00  0.00           C
ATOM      3  C   XXX A  34     126.386 210.806 173.507  1.00  0.00           C
ATOM      4  K   XXX A  34     127.304 211.628 173.503  1.00  0.00           K
ATOM      1  O   HOH A  34     135.208 211.886 175.417  1.00  0.00           O
ATOM      2  O   HOH A  34     135.035 211.123 174.168  1.00  0.00           O
ATOM      3  O   HOH A  34     136.386 210.806 173.507  1.00  0.00           O
ATOM      4  O   HOH A  34     137.304 211.628 173.503  1.00  0.00           O
TER
ATOM      5  N1  XXX B  34     251.532 143.432 175.422  1.00  0.00           N
ATOM      6  CT  XXX B  34     252.120 143.948 174.173  1.00  0.00           C
ATOM      7  C   XXX B  34     251.212 144.998 173.512  1.00  0.00           C
ATOM      8  K   XXX B  34     249.986 144.872 173.510  1.00  0.00           K
ATOM      5  O   HOH B  34     271.532 143.432 175.422  1.00  0.00           O
ATOM      6  O   HOH B  34     272.120 143.948 174.173  1.00  0.00           O
ATOM      7  O   HOH B  34     271.212 144.998 173.512  1.00  0.00           O
ATOM      8  O   HOH B  34     279.986 144.872 173.510  1.00  0.00           O
TER
"""

pdb_AB = '''\
ATOM      1  CB  MET B   1      52.886   1.976   9.011  1.00 41.44           C
ATOM      2  CG  MET B   1      53.271   0.996  10.102  1.00 47.36           C
ATOM      3  SD  MET B   1      55.066   1.105  10.320  1.00 54.87           S
ATOM      4  CE  MET B   1      55.198   1.758  11.963  1.00 52.95           C
ATOM      5  C   MET B   1      51.257   3.002   7.473  1.00 32.90           C
ATOM      6  O   MET B   1      51.643   3.028   6.297  1.00 33.11           O
ATOM      7  N   MET B   1      51.320   0.535   7.805  1.00 38.36           N
ATOM      8  CA  MET B   1      51.486   1.834   8.434  1.00 36.79           C
TER
ATOM      1  CB  MET A   1       0.115  20.271   3.107  1.00 41.44           C
ATOM      2  CG  MET A   1       0.717  21.085   1.978  1.00 47.36           C
ATOM      3  SD  MET A   1       1.424  22.584   2.709  1.00 54.87           S
ATOM      4  CE  MET A   1       3.156  22.361   2.406  1.00 52.95           C
ATOM      5  C   MET A   1      -1.177  18.359   3.971  1.00 32.90           C
ATOM      6  O   MET A   1      -2.072  18.689   4.760  1.00 33.11           O
ATOM      7  N   MET A   1      -1.968  19.642   1.989  1.00 38.36           N
ATOM      8  CA  MET A   1      -0.810  19.133   2.704  1.00 36.79           C
'''

pdb_space = '''\
ATOM      1  CB  MET     1      52.886   1.976   9.011  1.00 41.44           C
ATOM      2  CG  MET     1      53.271   0.996  10.102  1.00 47.36           C
ATOM      3  SD  MET     1      55.066   1.105  10.320  1.00 54.87           S
ATOM      4  CE  MET     1      55.198   1.758  11.963  1.00 52.95           C
ATOM      5  C   MET     1      51.257   3.002   7.473  1.00 32.90           C
ATOM      6  O   MET     1      51.643   3.028   6.297  1.00 33.11           O
ATOM      7  N   MET     1      51.320   0.535   7.805  1.00 38.36           N
ATOM      8  CA  MET     1      51.486   1.834   8.434  1.00 36.79           C
TER
ATOM      1  CB  MET A   1       0.115  20.271   3.107  1.00 41.44           C
ATOM      2  CG  MET A   1       0.717  21.085   1.978  1.00 47.36           C
ATOM      3  SD  MET A   1       1.424  22.584   2.709  1.00 54.87           S
ATOM      4  CE  MET A   1       3.156  22.361   2.406  1.00 52.95           C
ATOM      5  C   MET A   1      -1.177  18.359   3.971  1.00 32.90           C
ATOM      6  O   MET A   1      -2.072  18.689   4.760  1.00 33.11           O
ATOM      7  N   MET A   1      -1.968  19.642   1.989  1.00 38.36           N
ATOM      8  CA  MET A   1      -0.810  19.133   2.704  1.00 36.79           C
'''

pdb_stars = '''\
ATOM      1  CB  MET**   1      52.886   1.976   9.011  1.00 41.44           C
ATOM      2  CG  MET**   1      53.271   0.996  10.102  1.00 47.36           C
ATOM      3  SD  MET**   1      55.066   1.105  10.320  1.00 54.87           S
ATOM      4  CE  MET**   1      55.198   1.758  11.963  1.00 52.95           C
ATOM      5  C   MET**   1      51.257   3.002   7.473  1.00 32.90           C
ATOM      6  O   MET**   1      51.643   3.028   6.297  1.00 33.11           O
ATOM      7  N   MET**   1      51.320   0.535   7.805  1.00 38.36           N
ATOM      8  CA  MET**   1      51.486   1.834   8.434  1.00 36.79           C
TER
ATOM      1  CB  MET A   1       0.115  20.271   3.107  1.00 41.44           C
ATOM      2  CG  MET A   1       0.717  21.085   1.978  1.00 47.36           C
ATOM      3  SD  MET A   1       1.424  22.584   2.709  1.00 54.87           S
ATOM      4  CE  MET A   1       3.156  22.361   2.406  1.00 52.95           C
ATOM      5  C   MET A   1      -1.177  18.359   3.971  1.00 32.90           C
ATOM      6  O   MET A   1      -2.072  18.689   4.760  1.00 33.11           O
ATOM      7  N   MET A   1      -1.968  19.642   1.989  1.00 38.36           N
ATOM      8  CA  MET A   1      -0.810  19.133   2.704  1.00 36.79           C
'''

pdb_stars_and_spaces = '''\
ATOM      1  CB  MET**   1      52.886   1.976   9.011  1.00 41.44           C
ATOM      2  CG  MET**   1      53.271   0.996  10.102  1.00 47.36           C
ATOM      3  SD  MET**   1      55.066   1.105  10.320  1.00 54.87           S
ATOM      4  CE  MET**   1      55.198   1.758  11.963  1.00 52.95           C
ATOM      5  C   MET**   1      51.257   3.002   7.473  1.00 32.90           C
ATOM      6  O   MET**   1      51.643   3.028   6.297  1.00 33.11           O
ATOM      7  N   MET**   1      51.320   0.535   7.805  1.00 38.36           N
ATOM      8  CA  MET**   1      51.486   1.834   8.434  1.00 36.79           C
TER
ATOM      1  CB  MET     1       0.115  20.271   3.107  1.00 41.44           C
ATOM      2  CG  MET     1       0.717  21.085   1.978  1.00 47.36           C
ATOM      3  SD  MET     1       1.424  22.584   2.709  1.00 54.87           S
ATOM      4  CE  MET     1       3.156  22.361   2.406  1.00 52.95           C
ATOM      5  C   MET     1      -1.177  18.359   3.971  1.00 32.90           C
ATOM      6  O   MET     1      -2.072  18.689   4.760  1.00 33.11           O
ATOM      7  N   MET     1      -1.968  19.642   1.989  1.00 38.36           N
ATOM      8  CA  MET     1      -0.810  19.133   2.704  1.00 36.79           C
'''

def exercise_00(prefix="iotbx_ncs_exercise_00",debug=False):
  pdb_file_name = "%s.pdb"%prefix
  ncs_params_str = """
ncs_group {
  master_selection = chain A
  copy_selection = chain B
  copy_selection = chain C
}
  """
  def check_result(ncs_inp, test_i):
    if test_i == 0:
      l1, l2, l3 = [0,1,2,3], [4,5,6,7], [8,9,10,11]
    elif test_i == 1:
      l1, l2, l3 = [1,2,3,4], [5,6,7,8], [9,10,11,12]
    else: assert 0
    ncs_groups = ncs_inp.get_ncs_restraints_group_list()
    assert len(ncs_groups) == 1
    ncs_group = ncs_groups[0]
    assert approx_equal(ncs_group.master_iselection, l1)
    assert len(ncs_group.copies) == 2
    assert approx_equal(ncs_group.copies[0].iselection, l2)
    assert approx_equal(ncs_group.copies[1].iselection, l3)
  files_to_delete = []
  for test_i, pdb_str in enumerate([pdb_str_1, pdb_str_2]):
    of = open(pdb_file_name, "w")
    files_to_delete.append(pdb_file_name)
    print >> of, pdb_str
    of.close()
    pdb_inp = iotbx.pdb.input(file_name = pdb_file_name)
    if test_i == 0: # XXX Not implemented. Fix later.
      # using pdb_inp
      ncs_inp = ncs.input(pdb_inp = pdb_inp)
      check_result(ncs_inp,test_i)
      # using file_name
      ncs_inp = ncs.input(file_name = pdb_file_name)
      check_result(ncs_inp,test_i)
      # using pdb string
      ncs_inp = ncs.input(pdb_string = pdb_str)
      check_result(ncs_inp,test_i)
    # using combination of pdb_inp and Phil parameter string
    ncs_inp = ncs.input(pdb_inp = pdb_inp,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
    # using combination of pdb file name and Phil parameter string
    ncs_inp = ncs.input(file_name = pdb_file_name,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
    # using combination of pdb string and Phil parameter string
    ncs_inp = ncs.input(pdb_string = pdb_str,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
  # cleanup
  if not debug:
    clean_temp_files(files_to_delete)

def exercise_01(prefix="iotbx_ncs_exercise_01", debug=False):
  """
  Make sure provided selections take precedence and are correctly respected.
  """
  pdb_file_name = "%s.pdb"%prefix
  ncs_params_str = """
ncs_group {
  master_selection = chain C
  copy_selection = chain A
}
  """
  def check_result(ncs_inp, test_i):
    if test_i == 0:
      l1, l2 = [8,9,10,11], [0,1,2,3]
    elif test_i == 1:
      l1, l2 = [9,10,11,12], [1,2,3,4]
    else: assert 0
    ncs_groups = ncs_inp.get_ncs_restraints_group_list()
    assert len(ncs_groups) == 1
    ncs_group = ncs_groups[0]
    assert approx_equal(ncs_group.master_iselection, l1)
    assert len(ncs_group.copies) == 1
    assert approx_equal(ncs_group.copies[0].iselection, l2)
  files_to_delete = []
  for test_i, pdb_str in enumerate([pdb_str_1, pdb_str_2]):
    files_to_delete.append(pdb_file_name)
    of = open(pdb_file_name, "w")
    print >> of, pdb_str
    of.close()
    pdb_inp = iotbx.pdb.input(file_name = pdb_file_name)
    # using combination of pdb_inp and Phil parameter string
    ncs_inp = ncs.input(pdb_inp = pdb_inp,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
    # using combination of pdb file name and Phil parameter string
    ncs_inp = ncs.input(file_name = pdb_file_name,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
    # using combination of pdb string and Phil parameter string
    ncs_inp = ncs.input(pdb_string = pdb_str,
      ncs_phil_string = ncs_params_str)
    check_result(ncs_inp,test_i)
  if not debug:
    clean_temp_files(files_to_delete)

def exercise_02(prefix="iotbx_ncs_exercise_02", debug=False):
  """
  This is expected to fail as requested chains cannot be matched.
  """
  pdb_file_name = "%s.pdb"%prefix
  ncs_params_str = """
ncs_group {
  master_selection = chain C
  copy_selection = chain A
}
  """
  files_to_delete = []
  for test_i, pdb_str in enumerate([pdb_str_3, pdb_str_4]):
    files_to_delete.append(pdb_file_name)
    of = open(pdb_file_name, "w")
    print >> of, pdb_str
    of.close()
    pdb_inp = iotbx.pdb.input(file_name = pdb_file_name)
    # using combination of pdb_inp and Phil parameter string
    ncs_inp = ncs.input(pdb_inp = pdb_inp,
      ncs_phil_string = ncs_params_str)
    ncs_groups = ncs_inp.get_ncs_restraints_group_list(max_delta=310)
    # using combination of pdb file name and Phil parameter string
    ncs_inp = ncs.input(file_name = pdb_file_name,
      ncs_phil_string = ncs_params_str)
    ncs_groups = ncs_inp.get_ncs_restraints_group_list(max_delta=310)
    # using combination of pdb string and Phil parameter string
    ncs_inp = ncs.input(pdb_string = pdb_str,
      ncs_phil_string = ncs_params_str)
    ncs_groups = ncs_inp.get_ncs_restraints_group_list(max_delta=310)
  if not debug:
    clean_temp_files(files_to_delete)

def exercise_03():
  """
  Expect one master and 3 copies.
  """
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str_5)
  ncs_inp = ncs.input(pdb_inp = pdb_inp)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  asc = ncs_inp.hierarchy.atom_selection_cache()
  sel_master = asc.selection(string = "chain 1")
  sel_copy_1 = asc.selection(string = "chain A")
  sel_copy_2 = asc.selection(string = "chain B")
  sel_copy_3 = asc.selection(string = "chain C")
  assert len(ncs_groups)==1
  ng = ncs_groups[0]
  # chains are sorted by name (numbers first)
  assert approx_equal(sel_master.iselection(), ng.master_iselection)
  assert approx_equal(sel_copy_1.iselection(), ng.copies[0].iselection)
  assert approx_equal(sel_copy_2.iselection(), ng.copies[1].iselection)
  assert approx_equal(sel_copy_3.iselection(), ng.copies[2].iselection)

def exercise_04():
  """
  Testing one ncs group and master ncs with two chains of different length
  and chains are not in order
  """
  ncs_inp = ncs.input(pdb_string=pdb_str_6)
  t = ncs_inp.ncs_to_asu_selection
  assert t.keys() == ['chain A or chain B']
  assert t.values() == [['chain C or chain D', 'chain E or chain F']]

def exercise_05():
  """
  Make sure that phil selection overrides ncs grouping
  """
  phil_str = """\
ncs_group {
  master_selection = chain A
  copy_selection = chain C
}
ncs_group {
  master_selection = chain B
  copy_selection = chain D
}
"""
  ncs_inp = ncs.input(
    pdb_string=pdb_str_6,
    ncs_phil_string=phil_str)
  expected = {'chain A': ['chain C'], 'chain B': ['chain D']}
  assert ncs_inp.ncs_to_asu_selection.keys(), expected.keys()
  assert ncs_inp.ncs_to_asu_selection.values(), expected.values()

def exercise_06():
  """
  Two groups, different number of chain in each group.
  Two chains that are NOT ncs related
  """
  ncs_inp = ncs.input(pdb_string=pdb_str_7)
  t = ncs_inp.ncs_to_asu_selection
  assert t.keys() == ['chain D', 'chain A']
  assert t.values() == [['chain E'], ['chain B', 'chain C']]
  assert ncs_inp.ncs_group_map[1][0] == {'chain A'}
  assert ncs_inp.ncs_group_map[2][0] == {'chain D'}

def exercise_07():
  """
  Test that minimal number of chains in master ncs are selected (not the
  minimal number of transformations)
  """
  ncs_inp = ncs.input(pdb_string=pdb_str_8)
  t = ncs_inp.ncs_to_asu_selection
  assert t.keys() == ['chain A']
  assert t.values() == \
    [['chain B', 'chain C', 'chain D', 'chain E',
      'chain F', 'chain G', 'chain H', 'chain I']]

def exercise_08():
  """
  Test that minimal number of transformations in master ncs are selected
  (not the minimal number of chains)
  """
  ncs_inp = ncs.input(
    pdb_string=pdb_str_8,
    use_minimal_master_ncs=False)
  t = ncs_inp.ncs_to_asu_selection
  assert t.keys()==['chain A or chain B or chain C']
  assert t.values()==\
    [['chain D or chain E or chain F',
      'chain G or chain H or chain I']]

def exercise_09():
  """
  Test minimal master NCS grouping
  make sure it does not group together similar chains that can be grouped and
  that NCS group and transforms created properly
  """
  from mmtbx.ncs import ncs_search
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str_8)
  ph = pdb_inp.construct_hierarchy()
  #
  chain_match_list = ncs_search.search_ncs_relations(
    ph=ph,min_contig_length=0,min_percent=0)
  # make sure that all possible chains compared
  model  = ph.models()[0]
  chain_ids = list({x.id for x in model.chains()})
  chain_ids = sorted(chain_ids)
  n_chains = len(chain_ids)
  assert n_chains==9
  assert len(chain_match_list)==8
  #
  match_dict = ncs_search.clean_chain_matching(chain_match_list,ph)
  chains_info = ncs_search.get_chains_info(ph)
  # Test minimal master NCS
  transform_to_group,match_dict = ncs_search.minimal_master_ncs_grouping(
  match_dict=match_dict)
  group_dict = ncs_search.build_group_dict(
    transform_to_group,match_dict,chains_info)
  assert len(group_dict)==1
  gr_obj = group_dict[('A',)]
  assert len(gr_obj.transforms)==len(gr_obj.copies)
  assert len(gr_obj.iselections)==len(gr_obj.copies)
  expected = [['A'], ['B'], ['C'], ['D'], ['E'], ['F'], ['G'], ['H'], ['I']]
  assert gr_obj.copies == expected
  # make sure identity transform was entered as the first transform
  tr = gr_obj.transforms[0]
  assert tr.r.is_r3_identity_matrix()
  assert tr.t.is_col_zero()
  tr = gr_obj.transforms[1]
  assert not tr.r.is_r3_identity_matrix()
  assert not tr.t.is_col_zero()

def exercise_10():
  """ Test minimal NCS operators """
  from mmtbx.ncs import ncs_search
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str_8)
  ph = pdb_inp.construct_hierarchy()
  #
  chain_match_list = ncs_search.search_ncs_relations(
    ph=ph,min_contig_length=0,
    min_percent=0,
    use_minimal_master_ncs=False)
  #
  match_dict = ncs_search.clean_chain_matching(chain_match_list,ph)
  chains_info = ncs_search.get_chains_info(ph)
  #
  transform_to_group,match_dict = ncs_search.minimal_ncs_operators_grouping(
  match_dict=match_dict)
  group_dict = ncs_search.build_group_dict(
    transform_to_group,match_dict,chains_info)
  assert len(group_dict)==1
  gr_obj = group_dict[('A', 'B', 'C')]
  assert len(gr_obj.transforms)==len(gr_obj.copies)
  assert len(gr_obj.iselections)==len(gr_obj.copies)
  expected = [['A', 'B', 'C'], ['D', 'E', 'F'], ['G', 'H', 'I']]
  assert gr_obj.copies==expected
  tr = gr_obj.transforms[0]
  assert tr.r.is_r3_identity_matrix()
  assert tr.t.is_col_zero()
  tr = gr_obj.transforms[1]
  assert not tr.r.is_r3_identity_matrix()
  assert not tr.t.is_col_zero()

def exercise_11():
  """
  Make sure user-provided NCS groups are preserved. Also make sure two-letter
  chain ID are handled correctly
  """
  phil_str="""
ncs_group {
  master_selection = chain 'Aa' and (resseq 6:9 )
  copy_selection = chain 'Ac' and (resseq 6:9 )
}
ncs_group {
  master_selection = chain 'Ab' and (resseq 1:4 )
  copy_selection = chain 'Ad' and (resseq 1:4 )
}
"""
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_9).construct_hierarchy().atom_selection_cache()
  ### default
  ncs_inp = ncs.input(pdb_string = pdb_str_9)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain Aa or chain Ab").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain Ac or chain Ad").iselection())
  ### user-supplied
  ncs_inp = ncs.input(pdb_string = pdb_str_9, ncs_phil_string = phil_str)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==2
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain Aa and resseq 6:9").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain Ac and resseq 6:9").iselection())
  # group 2
  assert ncs_groups[1].master_iselection.all_eq(
    asc.selection(string = "chain Ab and resseq 1:4").iselection())
  g1_c = ncs_groups[1].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain Ad and resseq 1:4").iselection())

def exercise_12():
  """ Test dealing with chains names that are space or **"""
  ncs_obj_AB = ncs.input(pdb_string=pdb_AB)
  ncs_obj_space = ncs.input(pdb_string=pdb_space)
  ncs_obj_stars = ncs.input(pdb_string=pdb_stars)
  ncs_obj_str_and_spc = ncs.input(pdb_string=pdb_stars_and_spaces)
  #
  for ncs_obj in [ncs_obj_AB,ncs_obj_space,ncs_obj_stars,ncs_obj_str_and_spc]:
    keys = ncs_obj.common_res_dict.keys()
    assert len(keys) == 2
    for key in keys:
      ncs_sel = ncs_obj.common_res_dict[key][0][1]
      assert ncs_sel.size() == 8

def exercise_13():
  """
  PDB file with insertion codes.
  """
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_10).construct_hierarchy().atom_selection_cache()
  ncs_inp = ncs.input(pdb_string = pdb_str_10)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain H").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain L").iselection())

def exercise_14():
  """
  PDB file with alternative conformations.
  """
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_11).construct_hierarchy().atom_selection_cache()
  ncs_inp = ncs.input(pdb_string = pdb_str_11)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  assert ncs_groups[0].master_iselection.all_eq(asc.selection(
    string = "chain H and not (altloc A or altloc B)").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(asc.selection(
    string = "chain L and not (altloc A or altloc B)").iselection())

def exercise_15():
  """
  PDB file with MODEL-ENDMDL.
  """
  ncs_inp = ncs.input(pdb_string = pdb_str_12)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  ### CHECK FOR SORRY HERE

def exercise_16():
  """
  PDB file with nucleic acids.
  """
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_13).construct_hierarchy().atom_selection_cache()
  ncs_inp = ncs.input(pdb_string = pdb_str_13)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  assert ncs_groups[0].master_iselection.all_eq(asc.selection(
    string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(asc.selection(
    string = "chain aA").iselection())

def exercise_17():
  """
  PDB file with ligands.
  """
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_14).construct_hierarchy().atom_selection_cache()
  ncs_inp = ncs.input(pdb_string = pdb_str_14)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  assert ncs_groups[0].master_iselection.all_eq(asc.selection(
    string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==2
  assert g1_c[0].iselection.all_eq(asc.selection(
    string = "chain B").iselection())
  assert g1_c[1].iselection.all_eq(asc.selection(
    string = "chain C").iselection())

def exercise_18():
  """
  Include water if requested by user
  """
  phil_str="""
ncs_group {
  master_selection = chain A
  copy_selection = chain B
}
"""
  asc = iotbx.pdb.input(source_info=None,
    lines=pdb_str_15).construct_hierarchy().atom_selection_cache()
  ### user-supplied
  ncs_inp = ncs.input(pdb_string = pdb_str_15, ncs_phil_string = phil_str)
  ncs_groups = ncs_inp.get_ncs_restraints_group_list()
  assert len(ncs_groups)==1
  # group 1
  assert ncs_groups[0].master_iselection.all_eq(
    asc.selection(string = "chain A").iselection())
  g1_c = ncs_groups[0].copies
  assert len(g1_c)==1
  assert g1_c[0].iselection.all_eq(
    asc.selection(string = "chain B").iselection())

def clean_temp_files(file_list):
  """ delete files in the file_list """
  for fn in file_list:
    if os.path.isfile(fn): os.remove(fn)

if (__name__ == "__main__"):
  debug = ('debug' in sys.argv[1:])
  exercise_00(debug=debug)
  exercise_01(debug=debug)
  exercise_02(debug=debug)
  exercise_03()
  exercise_04()
  exercise_05()
  exercise_06()
  exercise_07()
  exercise_08()
  exercise_09()
  exercise_10()
  exercise_11()
  exercise_12()
  exercise_13()
  exercise_14()
  exercise_15()
  exercise_16()
  exercise_17()
  exercise_18()
