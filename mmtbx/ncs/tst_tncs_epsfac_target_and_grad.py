from __future__ import division
import cctbx.array_family.flex # import dependency
import boost.python
ext = boost.python.import_ext("mmtbx_ncs_ext")
import iotbx.pdb
from scitbx.array_family import flex
from mmtbx.ncs import tncs

pdb_str1 = """
CRYST1   21.954   18.566   12.975  90.00  90.00  90.00 P 1
ATOM      1  N   ALA A   1       7.622  14.852   6.274  1.00 20.00           N
ATOM      2  CA  ALA A   1       7.323  14.430   7.635  1.00 20.00           C
ATOM      3  C   ALA A   1       6.442  13.183   7.656  1.00 20.00           C
ATOM      4  O   ALA A   1       6.848  12.171   8.227  1.00 20.00           O
ATOM      5  CB  ALA A   1       6.675  15.566   8.414  1.00 20.00           C
ATOM      6  N   ALA A   2       5.256  13.245   7.012  1.00 20.00           N
ATOM      7  CA  ALA A   2       4.288  12.143   6.916  1.00 20.00           C
ATOM      8  C   ALA A   2       4.847  10.948   6.125  1.00 20.00           C
ATOM      9  O   ALA A   2       4.553   9.797   6.462  1.00 20.00           O
ATOM     10  CB  ALA A   2       3.000  12.642   6.276  1.00 20.00           C
ATOM     11  N   ALA A   3       5.664  11.231   5.084  1.00 20.00           N
ATOM     12  CA  ALA A   3       6.313  10.229   4.231  1.00 20.00           C
ATOM     13  C   ALA A   3       7.391   9.457   4.994  1.00 20.00           C
ATOM     14  O   ALA A   3       7.616   8.281   4.687  1.00 20.00           O
ATOM     15  CB  ALA A   3       6.915  10.892   3.000  1.00 20.00           C
ATOM     16  N   ALA A   4       8.063  10.119   5.976  1.00 20.00           N
ATOM     17  CA  ALA A   4       9.089   9.491   6.822  1.00 20.00           C
ATOM     18  C   ALA A   4       8.441   8.418   7.703  1.00 20.00           C
ATOM     19  O   ALA A   4       8.888   7.272   7.671  1.00 20.00           O
ATOM     20  CB  ALA A   4       9.785  10.535   7.683  1.00 20.00           C
ATOM     21  N   ALA A   5       7.338   8.773   8.423  1.00 20.00           N
ATOM     22  CA  ALA A   5       6.573   7.863   9.298  1.00 20.00           C
ATOM     23  C   ALA A   5       6.042   6.663   8.513  1.00 20.00           C
ATOM     24  O   ALA A   5       5.981   5.554   9.048  1.00 20.00           O
ATOM     25  CB  ALA A   5       5.433   8.608   9.975  1.00 20.00           C
ATOM     26  N   ALA A   6       5.715   6.893   7.221  1.00 20.00           N
ATOM     27  CA  ALA A   6       5.258   5.889   6.260  1.00 20.00           C
ATOM     28  C   ALA A   6       6.440   4.995   5.865  1.00 20.00           C
ATOM     29  O   ALA A   6       6.361   3.780   6.060  1.00 20.00           O
ATOM     30  CB  ALA A   6       4.664   6.568   5.032  1.00 20.00           C
ATOM     31  N   ALA A   7       7.556   5.609   5.374  1.00 20.00           N
ATOM     32  CA  ALA A   7       8.788   4.918   4.962  1.00 20.00           C
ATOM     33  C   ALA A   7       9.411   4.069   6.075  1.00 20.00           C
ATOM     34  O   ALA A   7       9.954   3.000   5.782  1.00 20.00           O
ATOM     35  CB  ALA A   7       9.806   5.915   4.433  1.00 20.00           C
TER
ATOM     36  N   ALA B   1      16.622  14.862   6.586  1.00 20.00           N
ATOM     37  CA  ALA B   1      16.323  14.369   7.923  1.00 20.00           C
ATOM     38  C   ALA B   1      15.442  13.123   7.879  1.00 20.00           C
ATOM     39  O   ALA B   1      15.848  12.082   8.396  1.00 20.00           O
ATOM     40  CB  ALA B   1      15.675  15.463   8.761  1.00 20.00           C
ATOM     41  N   ALA B   2      14.256  13.218   7.239  1.00 20.00           N
ATOM     42  CA  ALA B   2      13.288  12.123   7.086  1.00 20.00           C
ATOM     43  C   ALA B   2      13.847  10.971   6.233  1.00 20.00           C
ATOM     44  O   ALA B   2      13.553   9.804   6.509  1.00 20.00           O
ATOM     45  CB  ALA B   2      12.000  12.655   6.473  1.00 20.00           C
ATOM     46  N   ALA B   3      14.664  11.308   5.208  1.00 20.00           N
ATOM     47  CA  ALA B   3      15.313  10.352   4.304  1.00 20.00           C
ATOM     48  C   ALA B   3      16.391   9.541   5.026  1.00 20.00           C
ATOM     49  O   ALA B   3      16.616   8.383   4.658  1.00 20.00           O
ATOM     50  CB  ALA B   3      15.915  11.078   3.110  1.00 20.00           C
ATOM     51  N   ALA B   4      17.063  10.151   6.041  1.00 20.00           N
ATOM     52  CA  ALA B   4      18.089   9.479   6.853  1.00 20.00           C
ATOM     53  C   ALA B   4      17.441   8.362   7.677  1.00 20.00           C
ATOM     54  O   ALA B   4      17.888   7.219   7.585  1.00 20.00           O
ATOM     55  CB  ALA B   4      18.785  10.477   7.767  1.00 20.00           C
ATOM     56  N   ALA B   5      16.338   8.679   8.414  1.00 20.00           N
ATOM     57  CA  ALA B   5      15.573   7.724   9.240  1.00 20.00           C
ATOM     58  C   ALA B   5      15.042   6.567   8.394  1.00 20.00           C
ATOM     59  O   ALA B   5      14.981   5.431   8.870  1.00 20.00           O
ATOM     60  CB  ALA B   5      14.433   8.433   9.955  1.00 20.00           C
ATOM     61  N   ALA B   6      14.715   6.864   7.115  1.00 20.00           N
ATOM     62  CA  ALA B   6      14.258   5.912   6.103  1.00 20.00           C
ATOM     63  C   ALA B   6      15.440   5.040   5.662  1.00 20.00           C
ATOM     64  O   ALA B   6      15.361   3.816   5.793  1.00 20.00           O
ATOM     65  CB  ALA B   6      13.664   6.654   4.912  1.00 20.00           C
ATOM     66  N   ALA B   7      16.556   5.678   5.204  1.00 20.00           N
ATOM     67  CA  ALA B   7      17.788   5.010   4.756  1.00 20.00           C
ATOM     68  C   ALA B   7      18.411   4.104   5.823  1.00 20.00           C
ATOM     69  O   ALA B   7      18.954   3.052   5.475  1.00 20.00           O
ATOM     70  CB  ALA B   7      18.806   6.033   4.280  1.00 20.00           C
TER
END
"""

pdb_str2 = """
CRYST1   55.000   55.000   55.000  90.00  90.00  90.00 P 1
SCALE1      0.018182  0.000000  0.000000        0.00000
SCALE2      0.000000  0.018182  0.000000        0.00000
SCALE3      0.000000  0.000000  0.018182        0.00000
ATOM      1 O24  O24 A   1      17.807   7.000   9.804  1.00 10.00           O
ATOM      2 C30  C30 A   2       9.088  12.169  12.576  1.00 10.00           C
ATOM      3 O56  O56 A   3      16.007  12.944  16.782  1.00 10.00           O
ATOM      4 C91  C91 A   4      12.397  13.924  22.965  1.00 10.00           C
ATOM      5 N97  N97 A   5       9.443  18.769  16.978  1.00 10.00           N
ATOM      6 N101 N10 A   6      11.054  19.660  16.835  1.00 10.00           N
ATOM      7 C106 C10 A   7      18.784  19.068  15.239  1.00 10.00           C
ATOM      8 C146 C14 A   8      18.879  21.063  19.680  1.00 10.00           C
ATOM      9 N177 N17 A   9      17.994  12.605   8.848  1.00 10.00           N
ATOM     10 N237 N23 A  10      11.041  22.359  14.948  1.00 10.00           N
ATOM     11 N253 N25 A  11      18.617  18.612  18.047  1.00 10.00           N
ATOM     12 O352 O35 A  12      11.189  14.798  19.142  1.00 10.00           O
ATOM     13 C363 C36 A  13      11.292  15.686   9.065  1.00 10.00           C
ATOM     14 C395 C39 A  14      14.623  18.354  23.191  1.00 10.00           C
ATOM     15 O416 O41 A  15      16.869   6.883   9.516  1.00 10.00           O
ATOM     16 O424 O42 A  16      21.237  22.260  12.402  1.00 10.00           O
ATOM     17 C454 C45 A  17      16.092  11.379  23.146  1.00 10.00           C
ATOM     18 N481 N48 A  18       7.326   8.872  15.213  1.00 10.00           N
ATOM     19 C578 C57 A  19      12.719  18.745   9.044  1.00 10.00           C
ATOM     20 N637 N63 A  20      18.878  20.562   9.151  1.00 10.00           N
ATOM     21 C646 C64 A  21      14.733   5.649  17.033  1.00 10.00           C
ATOM     22 C714 C71 A  22      12.647  18.569   8.407  1.00 10.00           C
ATOM     23 C722 C72 A  23      23.581  19.042  16.459  1.00 10.00           C
ATOM     24 O752 O75 A  24      21.711  18.924  14.215  1.00 10.00           O
ATOM     25 C871 C87 A  25      19.418  11.178  21.906  1.00 10.00           C
ATOM     26 O904 O90 A  26      13.995  12.602  21.014  1.00 10.00           O
ATOM     27 O924 O92 A  27      18.710  15.890  22.087  1.00 10.00           O
ATOM     28 C963 C96 A  28      13.125  18.863  17.623  1.00 10.00           C
ATOM     29 C995 C99 A  29      18.357  12.193  10.040  1.00 10.00           C
ATOM     30 O124 O12 A  30      18.428  12.548   6.804  1.00 10.00           O
ATOM     31 C134 C13 A  31      14.296  12.328   8.483  1.00 10.00           C
ATOM     32 C138 C13 A  32      21.589   9.589  13.198  1.00 10.00           C
ATOM     33 O141 O14 A  33      16.231  16.368  13.759  1.00 10.00           O
ATOM     34 O141 O14 A  34      22.665  16.415  19.484  1.00 10.00           O
ATOM     35 C143 C14 A  35       9.588  12.547  12.478  1.00 10.00           C
ATOM     36 C149 C14 A  36      15.122  12.736  10.724  1.00 10.00           C
ATOM     37 N155 N15 A  37      19.538  10.408  17.273  1.00 10.00           N
ATOM     38 N161 N16 A  38      20.774   9.182  11.950  1.00 10.00           N
ATOM     39 C163 C16 A  39      13.651  19.563   8.515  1.00 10.00           C
ATOM     40 N164 N16 A  40      11.350  14.225  13.629  1.00 10.00           N
ATOM     41 C166 C16 A  41       9.990  11.209  11.520  1.00 10.00           C
ATOM     42 C167 C16 A  42      14.932  23.380  14.781  1.00 10.00           C
ATOM     43 C179 C17 A  43      18.572  19.902  13.460  1.00 10.00           C
ATOM     44 C180 C18 A  44      18.123   7.712  18.388  1.00 10.00           C
ATOM     45 C181 C18 A  45       9.283  14.612  14.997  1.00 10.00           C
ATOM     46 C182 C18 A  46      11.705  11.157  13.543  1.00 10.00           C
ATOM     47 C183 C18 A  47      18.348  21.219  17.367  1.00 10.00           C
ATOM     48 N183 N18 A  48      10.654  12.680  23.302  1.00 10.00           N
ATOM     49 N186 N18 A  49       8.983  15.826  12.793  1.00 10.00           N
ATOM     50 C188 C18 A  50      14.135  21.633  17.697  1.00 10.00           C
ATOM     51 C192 C19 A  51      13.418  23.425  12.009  1.00 10.00           C
ATOM     52 C203 C20 A  52      23.721  14.172  14.200  1.00 10.00           C
ATOM     53 C206 C20 A  53      14.133   9.528   9.490  1.00 10.00           C
ATOM     54 C208 C20 A  54      13.063  10.258  18.093  1.00 10.00           C
ATOM     55 C209 C20 A  55      12.445  20.084   8.297  1.00 10.00           C
ATOM     56 C211 C21 A  56       8.362  10.135  13.432  1.00 10.00           C
ATOM     57 O211 O21 A  57      14.695  11.497  24.311  1.00 10.00           O
ATOM     58 O219 O21 A  58      14.878   9.489  21.135  1.00 10.00           O
ATOM     59 N220 N22 A  59      10.151  21.586   9.598  1.00 10.00           N
ATOM     60 N221 N22 A  60      11.969  13.751  20.106  1.00 10.00           N
ATOM     61 C230 C23 A  61      15.467  17.291  15.353  1.00 10.00           C
ATOM     62 C235 C23 A  62      18.357  12.966  12.880  1.00 10.00           C
ATOM     63 C236 C23 A  63      12.292  12.068  13.931  1.00 10.00           C
ATOM     64 N236 N23 A  64      20.390  19.084  13.829  1.00 10.00           N
ATOM     65 O244 O24 A  65      17.917  21.358  19.552  1.00 10.00           O
ATOM     66 C246 C24 A  66      17.482  11.238  21.471  1.00 10.00           C
ATOM     67 N247 N24 A  67      12.897  18.681   9.782  1.00 10.00           N
ATOM     68 C247 C24 A  68      10.943  10.134   8.077  1.00 10.00           C
ATOM     69 C249 C24 A  69       9.150  18.265  16.700  1.00 10.00           C
ATOM     70 O253 O25 A  70      10.251  18.251  21.968  1.00 10.00           O
ATOM     71 C253 C25 A  71      21.618  15.259  16.211  1.00 10.00           C
ATOM     72 O257 O25 A  72      16.941  19.491  21.474  1.00 10.00           O
ATOM     73 C258 C25 A  73      17.153  19.709   9.304  1.00 10.00           C
ATOM     74 C264 C26 A  74      16.983  19.585  13.033  1.00 10.00           C
ATOM     75 C279 C27 A  75       8.124  12.517  10.854  1.00 10.00           C
ATOM     76 C282 C28 A  76      24.267  16.620  15.194  1.00 10.00           C
ATOM     77 N287 N28 A  77       9.401  11.308  17.216  1.00 10.00           N
ATOM     78 N296 N29 A  78      12.126  13.727  13.441  1.00 10.00           N
ATOM     79 N301 N30 A  79      22.435  20.265  13.857  1.00 10.00           N
ATOM     80 O302 O30 A  80      11.853  10.111   7.785  1.00 10.00           O
ATOM     81 O307 O30 A  81      18.216  10.869  15.007  1.00 10.00           O
ATOM     82 O314 O31 A  82      20.602  11.155  16.692  1.00 10.00           O
ATOM     83 N316 N31 A  83      12.590  14.990  14.480  1.00 10.00           N
ATOM     84 N317 N31 A  84      16.210  18.949  13.621  1.00 10.00           N
ATOM     85 O325 O32 A  85      15.332   7.690  13.326  1.00 10.00           O
ATOM     86 C328 C32 A  86      16.315   9.132  10.897  1.00 10.00           C
ATOM     87 N329 N32 A  87      13.933  23.043  15.050  1.00 10.00           N
ATOM     88 O334 O33 A  88       9.142  13.317  16.970  1.00 10.00           O
ATOM     89 C335 C33 A  89      16.591  17.394  10.424  1.00 10.00           C
ATOM     90 O337 O33 A  90      18.949  18.519  22.654  1.00 10.00           O
ATOM     91 O341 O34 A  91      15.839  23.270  11.098  1.00 10.00           O
ATOM     92 O344 O34 A  92      17.813  22.120  16.528  1.00 10.00           O
ATOM     93 C347 C34 A  93       8.262  21.315  12.940  1.00 10.00           C
ATOM     94 C357 C35 A  94       6.666  14.408  11.829  1.00 10.00           C
ATOM     95 C365 C36 A  95      17.552  19.233  10.373  1.00 10.00           C
ATOM     96 O367 O36 A  96      10.329  10.003  12.022  1.00 10.00           O
ATOM     97 C369 C36 A  97      14.093  20.437  20.726  1.00 10.00           C
ATOM     98 C372 C37 A  98      10.694   6.740  18.155  1.00 10.00           C
ATOM     99 C373 C37 A  99       8.560  17.125  21.437  1.00 10.00           C
ATOM    100 N379 N37 A 100      13.395  20.521  13.740  1.00 10.00           N
ATOM    101 C379 C37 A 101      16.766   9.346  19.942  1.00 10.00           C
ATOM    102 C382 C38 A 102      12.828  16.094   5.780  1.00 10.00           C
ATOM    103 N382 N38 A 103      21.705  15.446  17.135  1.00 10.00           N
ATOM    104 N384 N38 A 104      12.924  10.150  15.990  1.00 10.00           N
ATOM    105 O396 O39 A 105      15.614  18.749  22.600  1.00 10.00           O
ATOM    106 N398 N39 A 106      22.744  16.752  20.100  1.00 10.00           N
ATOM    107 C399 C39 A 107      10.923   8.352  14.101  1.00 10.00           C
TER
ATOM    108 O24  O24 B 108      37.807  27.000  29.804  1.00 10.00           O
ATOM    109 C30  C30 B 109      29.088  32.169  32.576  1.00 10.00           C
ATOM    110 O56  O56 B 110      36.007  32.944  36.782  1.00 10.00           O
ATOM    111 C91  C91 B 111      32.397  33.924  42.965  1.00 10.00           C
ATOM    112 N97  N97 B 112      29.443  38.769  36.978  1.00 10.00           N
ATOM    113 N101 N10 B 113      31.054  39.660  36.835  1.00 10.00           N
ATOM    114 C106 C10 B 114      38.784  39.068  35.239  1.00 10.00           C
ATOM    115 C146 C14 B 115      38.879  41.063  39.680  1.00 10.00           C
ATOM    116 N177 N17 B 116      37.994  32.605  28.848  1.00 10.00           N
ATOM    117 N237 N23 B 117      31.041  42.359  34.948  1.00 10.00           N
ATOM    118 N253 N25 B 118      38.617  38.612  38.047  1.00 10.00           N
ATOM    119 O352 O35 B 119      31.189  34.798  39.142  1.00 10.00           O
ATOM    120 C363 C36 B 120      31.292  35.686  29.065  1.00 10.00           C
ATOM    121 C395 C39 B 121      34.623  38.354  43.191  1.00 10.00           C
ATOM    122 O416 O41 B 122      36.869  26.883  29.516  1.00 10.00           O
ATOM    123 O424 O42 B 123      41.237  42.260  32.402  1.00 10.00           O
ATOM    124 C454 C45 B 124      36.092  31.379  43.146  1.00 10.00           C
ATOM    125 N481 N48 B 125      27.326  28.872  35.213  1.00 10.00           N
ATOM    126 C578 C57 B 126      32.719  38.745  29.044  1.00 10.00           C
ATOM    127 N637 N63 B 127      38.878  40.562  29.151  1.00 10.00           N
ATOM    128 C646 C64 B 128      34.733  25.649  37.033  1.00 10.00           C
ATOM    129 C714 C71 B 129      32.647  38.569  28.407  1.00 10.00           C
ATOM    130 C722 C72 B 130      43.581  39.042  36.459  1.00 10.00           C
ATOM    131 O752 O75 B 131      41.711  38.924  34.215  1.00 10.00           O
ATOM    132 C871 C87 B 132      39.418  31.178  41.906  1.00 10.00           C
ATOM    133 O904 O90 B 133      33.995  32.602  41.014  1.00 10.00           O
ATOM    134 O924 O92 B 134      38.710  35.890  42.087  1.00 10.00           O
ATOM    135 C963 C96 B 135      33.125  38.863  37.623  1.00 10.00           C
ATOM    136 C995 C99 B 136      38.357  32.193  30.040  1.00 10.00           C
ATOM    137 O124 O12 B 137      38.428  32.548  26.804  1.00 10.00           O
ATOM    138 C134 C13 B 138      34.296  32.328  28.483  1.00 10.00           C
ATOM    139 C138 C13 B 139      41.589  29.589  33.198  1.00 10.00           C
ATOM    140 O141 O14 B 140      36.231  36.368  33.759  1.00 10.00           O
ATOM    141 O141 O14 B 141      42.665  36.415  39.484  1.00 10.00           O
ATOM    142 C143 C14 B 142      29.588  32.547  32.478  1.00 10.00           C
ATOM    143 C149 C14 B 143      35.122  32.736  30.724  1.00 10.00           C
ATOM    144 N155 N15 B 144      39.538  30.408  37.273  1.00 10.00           N
ATOM    145 N161 N16 B 145      40.774  29.182  31.950  1.00 10.00           N
ATOM    146 C163 C16 B 146      33.651  39.563  28.515  1.00 10.00           C
ATOM    147 N164 N16 B 147      31.350  34.225  33.629  1.00 10.00           N
ATOM    148 C166 C16 B 148      29.990  31.209  31.520  1.00 10.00           C
ATOM    149 C167 C16 B 149      34.932  43.380  34.781  1.00 10.00           C
ATOM    150 C179 C17 B 150      38.572  39.902  33.460  1.00 10.00           C
ATOM    151 C180 C18 B 151      38.123  27.712  38.388  1.00 10.00           C
ATOM    152 C181 C18 B 152      29.283  34.612  34.997  1.00 10.00           C
ATOM    153 C182 C18 B 153      31.705  31.157  33.543  1.00 10.00           C
ATOM    154 C183 C18 B 154      38.348  41.219  37.367  1.00 10.00           C
ATOM    155 N183 N18 B 155      30.654  32.680  43.302  1.00 10.00           N
ATOM    156 N186 N18 B 156      28.983  35.826  32.793  1.00 10.00           N
ATOM    157 C188 C18 B 157      34.135  41.633  37.697  1.00 10.00           C
ATOM    158 C192 C19 B 158      33.418  43.425  32.009  1.00 10.00           C
ATOM    159 C203 C20 B 159      43.721  34.172  34.200  1.00 10.00           C
ATOM    160 C206 C20 B 160      34.133  29.528  29.490  1.00 10.00           C
ATOM    161 C208 C20 B 161      33.063  30.258  38.093  1.00 10.00           C
ATOM    162 C209 C20 B 162      32.445  40.084  28.297  1.00 10.00           C
ATOM    163 C211 C21 B 163      28.362  30.135  33.432  1.00 10.00           C
ATOM    164 O211 O21 B 164      34.695  31.497  44.311  1.00 10.00           O
ATOM    165 O219 O21 B 165      34.878  29.489  41.135  1.00 10.00           O
ATOM    166 N220 N22 B 166      30.151  41.586  29.598  1.00 10.00           N
ATOM    167 N221 N22 B 167      31.969  33.751  40.106  1.00 10.00           N
ATOM    168 C230 C23 B 168      35.467  37.291  35.353  1.00 10.00           C
ATOM    169 C235 C23 B 169      38.357  32.966  32.880  1.00 10.00           C
ATOM    170 C236 C23 B 170      32.292  32.068  33.931  1.00 10.00           C
ATOM    171 N236 N23 B 171      40.390  39.084  33.829  1.00 10.00           N
ATOM    172 O244 O24 B 172      37.917  41.358  39.552  1.00 10.00           O
ATOM    173 C246 C24 B 173      37.482  31.238  41.471  1.00 10.00           C
ATOM    174 N247 N24 B 174      32.897  38.681  29.782  1.00 10.00           N
ATOM    175 C247 C24 B 175      30.943  30.134  28.077  1.00 10.00           C
ATOM    176 C249 C24 B 176      29.150  38.265  36.700  1.00 10.00           C
ATOM    177 O253 O25 B 177      30.251  38.251  41.968  1.00 10.00           O
ATOM    178 C253 C25 B 178      41.618  35.259  36.211  1.00 10.00           C
ATOM    179 O257 O25 B 179      36.941  39.491  41.474  1.00 10.00           O
ATOM    180 C258 C25 B 180      37.153  39.709  29.304  1.00 10.00           C
ATOM    181 C264 C26 B 181      36.983  39.585  33.033  1.00 10.00           C
ATOM    182 C279 C27 B 182      28.124  32.517  30.854  1.00 10.00           C
ATOM    183 C282 C28 B 183      44.267  36.620  35.194  1.00 10.00           C
ATOM    184 N287 N28 B 184      29.401  31.308  37.216  1.00 10.00           N
ATOM    185 N296 N29 B 185      32.126  33.727  33.441  1.00 10.00           N
ATOM    186 N301 N30 B 186      42.435  40.265  33.857  1.00 10.00           N
ATOM    187 O302 O30 B 187      31.853  30.111  27.785  1.00 10.00           O
ATOM    188 O307 O30 B 188      38.216  30.869  35.007  1.00 10.00           O
ATOM    189 O314 O31 B 189      40.602  31.155  36.692  1.00 10.00           O
ATOM    190 N316 N31 B 190      32.590  34.990  34.480  1.00 10.00           N
ATOM    191 N317 N31 B 191      36.210  38.949  33.621  1.00 10.00           N
ATOM    192 O325 O32 B 192      35.332  27.690  33.326  1.00 10.00           O
ATOM    193 C328 C32 B 193      36.315  29.132  30.897  1.00 10.00           C
ATOM    194 N329 N32 B 194      33.933  43.043  35.050  1.00 10.00           N
ATOM    195 O334 O33 B 195      29.142  33.317  36.970  1.00 10.00           O
ATOM    196 C335 C33 B 196      36.591  37.394  30.424  1.00 10.00           C
ATOM    197 O337 O33 B 197      38.949  38.519  42.654  1.00 10.00           O
ATOM    198 O341 O34 B 198      35.839  43.270  31.098  1.00 10.00           O
ATOM    199 O344 O34 B 199      37.813  42.120  36.528  1.00 10.00           O
ATOM    200 C347 C34 B 200      28.262  41.315  32.940  1.00 10.00           C
ATOM    201 C357 C35 B 201      26.666  34.408  31.829  1.00 10.00           C
ATOM    202 C365 C36 B 202      37.552  39.233  30.373  1.00 10.00           C
ATOM    203 O367 O36 B 203      30.329  30.003  32.022  1.00 10.00           O
ATOM    204 C369 C36 B 204      34.093  40.437  40.726  1.00 10.00           C
ATOM    205 C372 C37 B 205      30.694  26.740  38.155  1.00 10.00           C
ATOM    206 C373 C37 B 206      28.560  37.125  41.437  1.00 10.00           C
ATOM    207 N379 N37 B 207      33.395  40.521  33.740  1.00 10.00           N
ATOM    208 C379 C37 B 208      36.766  29.346  39.942  1.00 10.00           C
ATOM    209 C382 C38 B 209      32.828  36.094  25.780  1.00 10.00           C
ATOM    210 N382 N38 B 210      41.705  35.446  37.135  1.00 10.00           N
ATOM    211 N384 N38 B 211      32.924  30.150  35.990  1.00 10.00           N
ATOM    212 O396 O39 B 212      35.614  38.749  42.600  1.00 10.00           O
ATOM    213 N398 N39 B 213      42.744  36.752  40.100  1.00 10.00           N
ATOM    214 C399 C39 B 214      30.923  28.352  34.101  1.00 10.00           C
END
"""

# Same as pdb_str with chain B slightly rotated
pdb_str3="""
CRYST1   55.000   55.000   55.000  90.00  90.00  90.00 P 1
SCALE1      0.018182  0.000000  0.000000        0.00000
SCALE2      0.000000  0.018182  0.000000        0.00000
SCALE3      0.000000  0.000000  0.018182        0.00000
ATOM      1 O24  O24 A   1      17.807   7.000   9.804  1.00 10.00           O
ATOM      2 C30  C30 A   2       9.088  12.169  12.576  1.00 10.00           C
ATOM      3 O56  O56 A   3      16.007  12.944  16.782  1.00 10.00           O
ATOM      4 C91  C91 A   4      12.397  13.924  22.965  1.00 10.00           C
ATOM      5 N97  N97 A   5       9.443  18.769  16.978  1.00 10.00           N
ATOM      6 N101 N10 A   6      11.054  19.660  16.835  1.00 10.00           N
ATOM      7 C106 C10 A   7      18.784  19.068  15.239  1.00 10.00           C
ATOM      8 C146 C14 A   8      18.879  21.063  19.680  1.00 10.00           C
ATOM      9 N177 N17 A   9      17.994  12.605   8.848  1.00 10.00           N
ATOM     10 N237 N23 A  10      11.041  22.359  14.948  1.00 10.00           N
ATOM     11 N253 N25 A  11      18.617  18.612  18.047  1.00 10.00           N
ATOM     12 O352 O35 A  12      11.189  14.798  19.142  1.00 10.00           O
ATOM     13 C363 C36 A  13      11.292  15.686   9.065  1.00 10.00           C
ATOM     14 C395 C39 A  14      14.623  18.354  23.191  1.00 10.00           C
ATOM     15 O416 O41 A  15      16.869   6.883   9.516  1.00 10.00           O
ATOM     16 O424 O42 A  16      21.237  22.260  12.402  1.00 10.00           O
ATOM     17 C454 C45 A  17      16.092  11.379  23.146  1.00 10.00           C
ATOM     18 N481 N48 A  18       7.326   8.872  15.213  1.00 10.00           N
ATOM     19 C578 C57 A  19      12.719  18.745   9.044  1.00 10.00           C
ATOM     20 N637 N63 A  20      18.878  20.562   9.151  1.00 10.00           N
ATOM     21 C646 C64 A  21      14.733   5.649  17.033  1.00 10.00           C
ATOM     22 C714 C71 A  22      12.647  18.569   8.407  1.00 10.00           C
ATOM     23 C722 C72 A  23      23.581  19.042  16.459  1.00 10.00           C
ATOM     24 O752 O75 A  24      21.711  18.924  14.215  1.00 10.00           O
ATOM     25 C871 C87 A  25      19.418  11.178  21.906  1.00 10.00           C
ATOM     26 O904 O90 A  26      13.995  12.602  21.014  1.00 10.00           O
ATOM     27 O924 O92 A  27      18.710  15.890  22.087  1.00 10.00           O
ATOM     28 C963 C96 A  28      13.125  18.863  17.623  1.00 10.00           C
ATOM     29 C995 C99 A  29      18.357  12.193  10.040  1.00 10.00           C
ATOM     30 O124 O12 A  30      18.428  12.548   6.804  1.00 10.00           O
ATOM     31 C134 C13 A  31      14.296  12.328   8.483  1.00 10.00           C
ATOM     32 C138 C13 A  32      21.589   9.589  13.198  1.00 10.00           C
ATOM     33 O141 O14 A  33      16.231  16.368  13.759  1.00 10.00           O
ATOM     34 O141 O14 A  34      22.665  16.415  19.484  1.00 10.00           O
ATOM     35 C143 C14 A  35       9.588  12.547  12.478  1.00 10.00           C
ATOM     36 C149 C14 A  36      15.122  12.736  10.724  1.00 10.00           C
ATOM     37 N155 N15 A  37      19.538  10.408  17.273  1.00 10.00           N
ATOM     38 N161 N16 A  38      20.774   9.182  11.950  1.00 10.00           N
ATOM     39 C163 C16 A  39      13.651  19.563   8.515  1.00 10.00           C
ATOM     40 N164 N16 A  40      11.350  14.225  13.629  1.00 10.00           N
ATOM     41 C166 C16 A  41       9.990  11.209  11.520  1.00 10.00           C
ATOM     42 C167 C16 A  42      14.932  23.380  14.781  1.00 10.00           C
ATOM     43 C179 C17 A  43      18.572  19.902  13.460  1.00 10.00           C
ATOM     44 C180 C18 A  44      18.123   7.712  18.388  1.00 10.00           C
ATOM     45 C181 C18 A  45       9.283  14.612  14.997  1.00 10.00           C
ATOM     46 C182 C18 A  46      11.705  11.157  13.543  1.00 10.00           C
ATOM     47 C183 C18 A  47      18.348  21.219  17.367  1.00 10.00           C
ATOM     48 N183 N18 A  48      10.654  12.680  23.302  1.00 10.00           N
ATOM     49 N186 N18 A  49       8.983  15.826  12.793  1.00 10.00           N
ATOM     50 C188 C18 A  50      14.135  21.633  17.697  1.00 10.00           C
ATOM     51 C192 C19 A  51      13.418  23.425  12.009  1.00 10.00           C
ATOM     52 C203 C20 A  52      23.721  14.172  14.200  1.00 10.00           C
ATOM     53 C206 C20 A  53      14.133   9.528   9.490  1.00 10.00           C
ATOM     54 C208 C20 A  54      13.063  10.258  18.093  1.00 10.00           C
ATOM     55 C209 C20 A  55      12.445  20.084   8.297  1.00 10.00           C
ATOM     56 C211 C21 A  56       8.362  10.135  13.432  1.00 10.00           C
ATOM     57 O211 O21 A  57      14.695  11.497  24.311  1.00 10.00           O
ATOM     58 O219 O21 A  58      14.878   9.489  21.135  1.00 10.00           O
ATOM     59 N220 N22 A  59      10.151  21.586   9.598  1.00 10.00           N
ATOM     60 N221 N22 A  60      11.969  13.751  20.106  1.00 10.00           N
ATOM     61 C230 C23 A  61      15.467  17.291  15.353  1.00 10.00           C
ATOM     62 C235 C23 A  62      18.357  12.966  12.880  1.00 10.00           C
ATOM     63 C236 C23 A  63      12.292  12.068  13.931  1.00 10.00           C
ATOM     64 N236 N23 A  64      20.390  19.084  13.829  1.00 10.00           N
ATOM     65 O244 O24 A  65      17.917  21.358  19.552  1.00 10.00           O
ATOM     66 C246 C24 A  66      17.482  11.238  21.471  1.00 10.00           C
ATOM     67 N247 N24 A  67      12.897  18.681   9.782  1.00 10.00           N
ATOM     68 C247 C24 A  68      10.943  10.134   8.077  1.00 10.00           C
ATOM     69 C249 C24 A  69       9.150  18.265  16.700  1.00 10.00           C
ATOM     70 O253 O25 A  70      10.251  18.251  21.968  1.00 10.00           O
ATOM     71 C253 C25 A  71      21.618  15.259  16.211  1.00 10.00           C
ATOM     72 O257 O25 A  72      16.941  19.491  21.474  1.00 10.00           O
ATOM     73 C258 C25 A  73      17.153  19.709   9.304  1.00 10.00           C
ATOM     74 C264 C26 A  74      16.983  19.585  13.033  1.00 10.00           C
ATOM     75 C279 C27 A  75       8.124  12.517  10.854  1.00 10.00           C
ATOM     76 C282 C28 A  76      24.267  16.620  15.194  1.00 10.00           C
ATOM     77 N287 N28 A  77       9.401  11.308  17.216  1.00 10.00           N
ATOM     78 N296 N29 A  78      12.126  13.727  13.441  1.00 10.00           N
ATOM     79 N301 N30 A  79      22.435  20.265  13.857  1.00 10.00           N
ATOM     80 O302 O30 A  80      11.853  10.111   7.785  1.00 10.00           O
ATOM     81 O307 O30 A  81      18.216  10.869  15.007  1.00 10.00           O
ATOM     82 O314 O31 A  82      20.602  11.155  16.692  1.00 10.00           O
ATOM     83 N316 N31 A  83      12.590  14.990  14.480  1.00 10.00           N
ATOM     84 N317 N31 A  84      16.210  18.949  13.621  1.00 10.00           N
ATOM     85 O325 O32 A  85      15.332   7.690  13.326  1.00 10.00           O
ATOM     86 C328 C32 A  86      16.315   9.132  10.897  1.00 10.00           C
ATOM     87 N329 N32 A  87      13.933  23.043  15.050  1.00 10.00           N
ATOM     88 O334 O33 A  88       9.142  13.317  16.970  1.00 10.00           O
ATOM     89 C335 C33 A  89      16.591  17.394  10.424  1.00 10.00           C
ATOM     90 O337 O33 A  90      18.949  18.519  22.654  1.00 10.00           O
ATOM     91 O341 O34 A  91      15.839  23.270  11.098  1.00 10.00           O
ATOM     92 O344 O34 A  92      17.813  22.120  16.528  1.00 10.00           O
ATOM     93 C347 C34 A  93       8.262  21.315  12.940  1.00 10.00           C
ATOM     94 C357 C35 A  94       6.666  14.408  11.829  1.00 10.00           C
ATOM     95 C365 C36 A  95      17.552  19.233  10.373  1.00 10.00           C
ATOM     96 O367 O36 A  96      10.329  10.003  12.022  1.00 10.00           O
ATOM     97 C369 C36 A  97      14.093  20.437  20.726  1.00 10.00           C
ATOM     98 C372 C37 A  98      10.694   6.740  18.155  1.00 10.00           C
ATOM     99 C373 C37 A  99       8.560  17.125  21.437  1.00 10.00           C
ATOM    100 N379 N37 A 100      13.395  20.521  13.740  1.00 10.00           N
ATOM    101 C379 C37 A 101      16.766   9.346  19.942  1.00 10.00           C
ATOM    102 C382 C38 A 102      12.828  16.094   5.780  1.00 10.00           C
ATOM    103 N382 N38 A 103      21.705  15.446  17.135  1.00 10.00           N
ATOM    104 N384 N38 A 104      12.924  10.150  15.990  1.00 10.00           N
ATOM    105 O396 O39 A 105      15.614  18.749  22.600  1.00 10.00           O
ATOM    106 N398 N39 A 106      22.744  16.752  20.100  1.00 10.00           N
ATOM    107 C399 C39 A 107      10.923   8.352  14.101  1.00 10.00           C
TER
ATOM    108 O24  O24 B 108      37.803  27.033  29.751  1.00 10.00           O
ATOM    109 C30  C30 B 109      29.085  32.172  32.581  1.00 10.00           C
ATOM    110 O56  O56 B 110      36.017  32.937  36.767  1.00 10.00           O
ATOM    111 C91  C91 B 111      32.427  33.878  42.967  1.00 10.00           C
ATOM    112 N97  N97 B 112      29.444  38.749  37.016  1.00 10.00           N
ATOM    113 N101 N10 B 113      31.052  39.644  36.872  1.00 10.00           N
ATOM    114 C106 C10 B 114      38.778  39.074  35.246  1.00 10.00           C
ATOM    115 C146 C14 B 115      38.885  41.046  39.697  1.00 10.00           C
ATOM    116 N177 N17 B 116      37.977  32.643  28.824  1.00 10.00           N
ATOM    117 N237 N23 B 117      31.028  42.352  34.999  1.00 10.00           N
ATOM    118 N253 N25 B 118      38.621  38.603  38.052  1.00 10.00           N
ATOM    119 O352 O35 B 119      31.204  34.770  39.153  1.00 10.00           O
ATOM    120 C363 C36 B 120      31.270  35.711  29.081  1.00 10.00           C
ATOM    121 C395 C39 B 121      34.646  38.311  43.209  1.00 10.00           C
ATOM    122 O416 O41 B 122      36.864  26.915  29.466  1.00 10.00           O
ATOM    123 O424 O42 B 123      41.215  42.285  32.417  1.00 10.00           O
ATOM    124 C454 C45 B 124      36.127  31.339  43.122  1.00 10.00           C
ATOM    125 N481 N48 B 125      27.338  28.858  35.207  1.00 10.00           N
ATOM    126 C578 C57 B 126      32.692  38.772  29.071  1.00 10.00           C
ATOM    127 N637 N63 B 127      38.848  40.600  29.166  1.00 10.00           N
ATOM    128 C646 C64 B 128      34.757  25.638  36.984  1.00 10.00           C
ATOM    129 C714 C71 B 129      32.618  38.600  28.433  1.00 10.00           C
ATOM    130 C722 C72 B 130      43.579  39.050  36.449  1.00 10.00           C
ATOM    131 O752 O75 B 131      41.702  38.940  34.211  1.00 10.00           O
ATOM    132 C871 C87 B 132      39.449  31.150  41.869  1.00 10.00           C
ATOM    133 O904 O90 B 133      34.020  32.569  41.004  1.00 10.00           O
ATOM    134 O924 O92 B 134      38.733  35.860  42.078  1.00 10.00           O
ATOM    135 C963 C96 B 135      33.128  38.846  37.649  1.00 10.00           C
ATOM    136 C995 C99 B 136      38.345  32.225  30.013  1.00 10.00           C
ATOM    137 O124 O12 B 137      38.404  32.597  26.778  1.00 10.00           O
ATOM    138 C134 C13 B 138      34.278  32.361  28.471  1.00 10.00           C
ATOM    139 C138 C13 B 139      41.592  29.610  33.146  1.00 10.00           C
ATOM    140 O141 O14 B 140      36.224  36.377  33.761  1.00 10.00           O
ATOM    141 O141 O14 B 141      42.678  36.405  39.464  1.00 10.00           O
ATOM    142 C143 C14 B 142      29.584  32.551  32.483  1.00 10.00           C
ATOM    143 C149 C14 B 143      35.111  32.759  30.711  1.00 10.00           C
ATOM    144 N155 N15 B 144      39.554  30.404  37.232  1.00 10.00           N
ATOM    145 N161 N16 B 145      40.774  29.209  31.898  1.00 10.00           N
ATOM    146 C163 C16 B 146      33.621  39.595  28.543  1.00 10.00           C
ATOM    147 N164 N16 B 147      31.347  34.226  33.637  1.00 10.00           N
ATOM    148 C166 C16 B 148      29.985  31.219  31.517  1.00 10.00           C
ATOM    149 C167 C16 B 149      34.917  43.381  34.824  1.00 10.00           C
ATOM    150 C179 C17 B 150      38.558  39.917  33.472  1.00 10.00           C
ATOM    151 C180 C18 B 151      38.148  27.700  38.338  1.00 10.00           C
ATOM    152 C181 C18 B 152      29.284  34.602  35.014  1.00 10.00           C
ATOM    153 C182 C18 B 153      31.707  31.159  33.533  1.00 10.00           C
ATOM    154 C183 C18 B 154      38.346  41.213  37.387  1.00 10.00           C
ATOM    155 N183 N18 B 155      30.687  32.629  43.304  1.00 10.00           N
ATOM    156 N186 N18 B 156      28.974  35.827  32.817  1.00 10.00           N
ATOM    157 C188 C18 B 157      34.133  41.618  37.734  1.00 10.00           C
ATOM    158 C192 C19 B 158      33.393  43.438  32.058  1.00 10.00           C
ATOM    159 C203 C20 B 159      43.720  34.192  34.164  1.00 10.00           C
ATOM    160 C206 C20 B 160      34.123  29.556  29.463  1.00 10.00           C
ATOM    161 C208 C20 B 161      33.082  30.239  38.074  1.00 10.00           C
ATOM    162 C209 C20 B 162      32.413  40.115  28.332  1.00 10.00           C
ATOM    163 C211 C21 B 163      28.365  30.132  33.429  1.00 10.00           C
ATOM    164 O211 O21 B 164      34.734  31.448  44.292  1.00 10.00           O
ATOM    165 O219 O21 B 165      34.909  29.457  41.105  1.00 10.00           O
ATOM    166 N220 N22 B 166      30.121  41.606  29.648  1.00 10.00           N
ATOM    167 N221 N22 B 167      31.989  33.719  40.109  1.00 10.00           N
ATOM    168 C230 C23 B 168      35.464  37.290  35.362  1.00 10.00           C
ATOM    169 C235 C23 B 169      38.353  32.983  32.857  1.00 10.00           C
ATOM    170 C236 C23 B 170      32.294  32.069  33.924  1.00 10.00           C
ATOM    171 N236 N23 B 171      40.379  39.100  33.831  1.00 10.00           N
ATOM    172 O244 O24 B 172      37.922  41.339  39.574  1.00 10.00           O
ATOM    173 C246 C24 B 173      37.511  31.209  41.441  1.00 10.00           C
ATOM    174 N247 N24 B 174      32.873  38.705  29.808  1.00 10.00           N
ATOM    175 C247 C24 B 175      30.928  30.163  28.065  1.00 10.00           C
ATOM    176 C249 C24 B 176      29.150  38.246  36.736  1.00 10.00           C
ATOM    177 O253 O25 B 177      30.270  38.206  42.000  1.00 10.00           O
ATOM    178 C253 C25 B 178      41.622  35.265  36.188  1.00 10.00           C
ATOM    179 O257 O25 B 179      36.956  39.461  41.490  1.00 10.00           O
ATOM    180 C258 C25 B 180      37.125  39.743  29.320  1.00 10.00           C
ATOM    181 C264 C26 B 181      36.968  39.599  33.049  1.00 10.00           C
ATOM    182 C279 C27 B 182      28.114  32.527  30.864  1.00 10.00           C
ATOM    183 C282 C28 B 183      44.265  36.636  35.169  1.00 10.00           C
ATOM    184 N287 N28 B 184      29.415  31.287  37.215  1.00 10.00           N
ATOM    185 N296 N29 B 185      32.123  33.730  33.443  1.00 10.00           N
ATOM    186 N301 N30 B 186      42.422  40.284  33.858  1.00 10.00           N
ATOM    187 O302 O30 B 187      31.837  30.144  27.769  1.00 10.00           O
ATOM    188 O307 O30 B 188      38.223  30.875  34.973  1.00 10.00           O
ATOM    189 O314 O31 B 189      40.615  31.156  36.651  1.00 10.00           O
ATOM    190 N316 N31 B 190      32.588  34.989  34.487  1.00 10.00           N
ATOM    191 N317 N31 B 191      36.198  38.959  33.636  1.00 10.00           N
ATOM    192 O325 O32 B 192      35.339  27.700  33.286  1.00 10.00           O
ATOM    193 C328 C32 B 193      36.311  29.156  30.861  1.00 10.00           C
ATOM    194 N329 N32 B 194      33.919  43.041  35.095  1.00 10.00           N
ATOM    195 O334 O33 B 195      29.152  33.297  36.980  1.00 10.00           O
ATOM    196 C335 C33 B 196      36.571  37.421  30.430  1.00 10.00           C
ATOM    197 O337 O33 B 197      38.970  38.486  42.658  1.00 10.00           O
ATOM    198 O341 O34 B 198      35.811  43.292  31.137  1.00 10.00           O
ATOM    199 O344 O34 B 199      37.806  42.117  36.554  1.00 10.00           O
ATOM    200 C347 C34 B 200      28.244  41.314  32.996  1.00 10.00           C
ATOM    201 C357 C35 B 201      26.656  34.410  31.854  1.00 10.00           C
ATOM    202 C365 C36 B 202      37.529  39.262  30.385  1.00 10.00           C
ATOM    203 O367 O36 B 203      30.328  30.011  32.011  1.00 10.00           O
ATOM    204 C369 C36 B 204      34.104  40.406  40.757  1.00 10.00           C
ATOM    205 C372 C37 B 205      30.720  26.716  38.126  1.00 10.00           C
ATOM    206 C373 C37 B 206      28.579  37.080  41.469  1.00 10.00           C
ATOM    207 N379 N37 B 207      33.381  40.525  33.774  1.00 10.00           N
ATOM    208 C379 C37 B 208      36.793  29.324  39.905  1.00 10.00           C
ATOM    209 C382 C38 B 209      32.794  36.139  25.792  1.00 10.00           C
ATOM    210 N382 N38 B 210      41.712  35.447  37.113  1.00 10.00           N
ATOM    211 N384 N38 B 211      32.936  30.142  35.971  1.00 10.00           N
ATOM    212 O396 O39 B 212      35.634  38.711  42.616  1.00 10.00           O
ATOM    213 N398 N39 B 213      42.759  36.739  40.081  1.00 10.00           N
ATOM    214 C399 C39 B 214      30.932  28.350  34.079  1.00 10.00           C
TER
END
"""

def run(reflections_per_bin=250):
  #
  # Read PDB file from string above, create xray_structure object
  #
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str1)
  pdb_inp.write_pdb_file(file_name="model.pdb")
  xray_structure = pdb_inp.xray_structure_simple()
  #
  # Calculate "Fobs" from this model
  #
  f_obs = abs(xray_structure.structure_factors(d_min=2.0).f_calc())
  f_obs.set_sigmas(sigmas = flex.double(f_obs.data().size(), 1.0))
  f_obs.setup_binner(reflections_per_bin = reflections_per_bin)
  binner = f_obs.binner()
  n_bins = binner.n_bins_used()
  #
  # Create NCS pair object that contains all information we will need.
  # This is C++ container implemented in cctbx_project/mmtbx/ncs/tncs.h
  #
  ############
  rad = 1.
  rad_best=None
  target=1.e+200
  while rad<50:
    o = tncs.groups(
      pdb_hierarchy    = pdb_inp.construct_hierarchy(),
      crystal_symmetry = pdb_inp.crystal_symmetry(),
      n_bins           = n_bins,
      rad              = rad)
    pot = tncs.potential(f_obs = f_obs, ncs_pairs = o.ncs_pairs,
      reflections_per_bin = reflections_per_bin)
    m = tncs.minimizer(
      potential = pot.set_refine_rhoMN(),
      use_bounds=2,
      lower_bound=0.,
      upper_bound=1.,
      initial_values=pot.ncs_pairs[0].rho_mn).run()
    if(m.f < target):
      target = m.f
      rad_best = rad
    rad += 1.
  print "Best rad (grid search):", rad_best
  ############
  o = tncs.groups(
    pdb_hierarchy    = pdb_inp.construct_hierarchy(),
    crystal_symmetry = pdb_inp.crystal_symmetry(),
    n_bins           = n_bins, rad=rad_best)
  o.show_summary()
  # Target and gradients evaluator
  pot = tncs.potential(f_obs = f_obs, ncs_pairs = o.ncs_pairs,
    reflections_per_bin = reflections_per_bin)
  for it in xrange(10):
    # refine radius
    m = tncs.minimizer(
      potential      = pot.set_refine_radius(),
      use_bounds     = 2,
      lower_bound    = 1.,
      upper_bound    = 50.,
      initial_values = flex.double([pot.ncs_pairs[0].radius]) ).run()
    # refine eps fac
    m = tncs.minimizer(
      potential      = pot.set_refine_rhoMN(),
      use_bounds     = 2,
      lower_bound    = 0.,
      upper_bound    = 1.,
      initial_values = pot.ncs_pairs[0].rho_mn).run()
  print "tncs_epsfac, first 10:", list(pot.target_and_grads.tncs_epsfac())[:10]
  print "tncs_epsfac min/max/mean:", \
    pot.target_and_grads.tncs_epsfac().min_max_mean().as_tuple()
  print "refined radius:", pot.ncs_pairs[0].radius
  #

if (__name__ == "__main__"):
  run()
