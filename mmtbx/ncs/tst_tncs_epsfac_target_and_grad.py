from __future__ import division
import cctbx.array_family.flex # import dependency
import boost.python
ext = boost.python.import_ext("mmtbx_ncs_ext")
import iotbx.pdb
from mmtbx.ncs import tncs

pdb_str="""
CRYST1   55.000   55.000   55.000  90.00  90.00  90.00 P 1
SCALE1      0.018182  0.000000  0.000000        0.00000
SCALE2      0.000000  0.018182  0.000000        0.00000
SCALE3      0.000000  0.000000  0.018182        0.00000
ATOM      1 C7    C7 A   1      13.701  17.636  20.433  1.00 10.00           C
ATOM      2 C116 C11 A   2      12.366   6.187  17.949  1.00 10.00           C
ATOM      3 C135 C13 A   3      12.358  18.443  20.392  1.00 10.00           C
ATOM      4 C318 C31 A   4      16.723   9.456  15.994  1.00 10.00           C
ATOM      5 C325 C32 A   5      13.023  10.841  10.069  1.00 10.00           C
ATOM      6 C375 C37 A   6      12.752  15.083   6.413  1.00 10.00           C
ATOM      7 C393 C39 A   7      10.852  10.986   7.235  1.00 10.00           C
ATOM      8 C423 C42 A   8       6.856  17.368  17.973  1.00 10.00           C
ATOM      9 C529 C52 A   9       8.289  18.565  18.488  1.00 10.00           C
ATOM     10 C582 C58 A  10      18.055  19.070   8.401  1.00 10.00           C
ATOM     11 C668 C66 A  11       9.912  22.046  11.754  1.00 10.00           C
ATOM     12 C723 C72 A  12      12.430  16.010  19.850  1.00 10.00           C
ATOM     13 C768 C76 A  13      11.102  15.960  19.526  1.00 10.00           C
ATOM     14 C769 C76 A  14       8.437  12.573  12.854  1.00 10.00           C
ATOM     15 C801 C80 A  15      17.327  17.934  17.256  1.00 10.00           C
ATOM     16 C829 C82 A  16       8.276  18.775  10.775  1.00 10.00           C
ATOM     17 C845 C84 A  17      12.801  22.237   9.595  1.00 10.00           C
ATOM     18 C900 C90 A  18      14.712  14.808  14.485  1.00 10.00           C
ATOM     19 C959 C95 A  19       7.926  15.643   9.501  1.00 10.00           C
ATOM     20 C978 C97 A  20      13.077  16.727  22.622  1.00 10.00           C
ATOM     21 C104 C10 A  21      11.201   9.953  17.040  1.00 10.00           C
ATOM     22 C107 C10 A  22       9.132   7.449  13.843  1.00 10.00           C
ATOM     23 C109 C10 A  23      17.073  16.541  15.076  1.00 10.00           C
ATOM     24 C113 C11 A  24      18.273  10.890  19.158  1.00 10.00           C
ATOM     25 C114 C11 A  25       9.020  12.518  15.904  1.00 10.00           C
ATOM     26 C129 C12 A  26      19.727   9.098  21.104  1.00 10.00           C
ATOM     27 C129 C12 A  27      23.544  17.469  18.536  1.00 10.00           C
ATOM     28 C130 C13 A  28      17.361  17.842  13.001  1.00 10.00           C
ATOM     29 C134 C13 A  29      17.419  12.979  14.542  1.00 10.00           C
ATOM     30 C152 C15 A  30      19.464  11.727  19.346  1.00 10.00           C
ATOM     31 C153 C15 A  31      22.842  12.077  10.237  1.00 10.00           C
ATOM     32 C154 C15 A  32      16.451  13.085  16.752  1.00 10.00           C
ATOM     33 C164 C16 A  33      10.038  20.697  14.559  1.00 10.00           C
ATOM     34 C167 C16 A  34      14.185  20.324   7.437  1.00 10.00           C
ATOM     35 C168 C16 A  35       6.300  17.761  11.873  1.00 10.00           C
ATOM     36 C169 C16 A  36      22.681  12.748  10.334  1.00 10.00           C
ATOM     37 C174 C17 A  37      14.879  15.242  21.473  1.00 10.00           C
ATOM     38 C177 C17 A  38      12.619  10.245  17.743  1.00 10.00           C
ATOM     39 C178 C17 A  39      20.810  12.695  12.135  1.00 10.00           C
ATOM     40 C183 C18 A  40      19.126  18.354  21.302  1.00 10.00           C
ATOM     41 C186 C18 A  41      22.171   9.795  15.535  1.00 10.00           C
ATOM     42 C187 C18 A  42      10.123  20.228  15.505  1.00 10.00           C
ATOM     43 C189 C18 A  43      14.218  20.351  20.400  1.00 10.00           C
ATOM     44 C190 C19 A  44      17.990  14.381   8.065  1.00 10.00           C
ATOM     45 C192 C19 A  45      22.487  11.050   9.852  1.00 10.00           C
ATOM     46 C195 C19 A  46      13.513   9.358  17.902  1.00 10.00           C
ATOM     47 C216 C21 A  47      19.547  19.669  18.906  1.00 10.00           C
ATOM     48 C221 C22 A  48      16.348  19.661  14.511  1.00 10.00           C
ATOM     49 C226 C22 A  49      14.910  11.972  18.502  1.00 10.00           C
ATOM     50 C229 C22 A  50      18.475  23.509  15.945  1.00 10.00           C
ATOM     51 C234 C23 A  51      11.102  10.570  17.360  1.00 10.00           C
ATOM     52 C237 C23 A  52      14.353  22.477  18.648  1.00 10.00           C
ATOM     53 C247 C24 A  53       9.150  19.933  10.445  1.00 10.00           C
ATOM     54 C250 C25 A  54      18.684   6.783  11.555  1.00 10.00           C
ATOM     55 C253 C25 A  55      22.260  15.618  18.081  1.00 10.00           C
ATOM     56 C254 C25 A  56       8.434  20.022  15.818  1.00 10.00           C
ATOM     57 C259 C25 A  57      16.042  14.366   5.312  1.00 10.00           C
ATOM     58 C262 C26 A  58      21.392  21.650  14.481  1.00 10.00           C
ATOM     59 C264 C26 A  59       6.678  17.698  12.625  1.00 10.00           C
ATOM     60 C269 C26 A  60       8.327  12.879  17.470  1.00 10.00           C
ATOM     61 C271 C27 A  61       7.510   9.079  17.557  1.00 10.00           C
ATOM     62 C273 C27 A  62      11.103  16.026  20.771  1.00 10.00           C
ATOM     63 C279 C27 A  63      19.453   8.063  20.118  1.00 10.00           C
ATOM     64 C285 C28 A  64      18.893   7.710  10.625  1.00 10.00           C
ATOM     65 C295 C29 A  65      20.485  20.440  11.734  1.00 10.00           C
ATOM     66 C304 C30 A  66      13.310  10.067  10.497  1.00 10.00           C
ATOM     67 C304 C30 A  67      13.522  10.034  22.514  1.00 10.00           C
ATOM     68 C307 C30 A  68      13.752   5.717  11.896  1.00 10.00           C
ATOM     69 C309 C30 A  69       9.873  10.448  12.931  1.00 10.00           C
ATOM     70 C316 C31 A  70      17.329  16.937  17.428  1.00 10.00           C
ATOM     71 C316 C31 A  71      12.746  11.817  20.837  1.00 10.00           C
ATOM     72 C336 C33 A  72      17.247  10.742  17.405  1.00 10.00           C
ATOM     73 C337 C33 A  73      21.636  11.562  20.613  1.00 10.00           C
ATOM     74 C344 C34 A  74      20.145  20.995  20.309  1.00 10.00           C
ATOM     75 C345 C34 A  75       9.873  12.910  10.483  1.00 10.00           C
ATOM     76 C348 C34 A  76      14.952  20.215  12.301  1.00 10.00           C
ATOM     77 C357 C35 A  77       9.415  11.208   8.319  1.00 10.00           C
ATOM     78 C358 C35 A  78      14.853  16.782  11.204  1.00 10.00           C
ATOM     79 C364 C36 A  79      13.852  15.132  24.685  1.00 10.00           C
ATOM     80 C366 C36 A  80      18.626  10.327  17.281  1.00 10.00           C
ATOM     81 C376 C37 A  81      13.940  16.792  11.870  1.00 10.00           C
ATOM     82 C392 C39 A  82      10.279  17.606  21.633  1.00 10.00           C
ATOM     83 C395 C39 A  83       5.395  16.876  15.353  1.00 10.00           C
ATOM     84 C399 C39 A  84      12.370  14.354  19.736  1.00 10.00           C
TER
ATOM     85 C7    C7 B  85      33.714  37.608  40.450  1.00 10.00           C
ATOM     86 C116 C11 B  86      32.390  26.170  37.911  1.00 10.00           C
ATOM     87 C135 C13 B  87      32.369  38.413  40.418  1.00 10.00           C
ATOM     88 C318 C31 B  88      36.735  29.457  35.958  1.00 10.00           C
ATOM     89 C325 C32 B  89      33.011  30.866  30.053  1.00 10.00           C
ATOM     90 C375 C37 B  90      32.720  35.127  26.421  1.00 10.00           C
ATOM     91 C393 C39 B  91      30.830  31.022  27.228  1.00 10.00           C
ATOM     92 C423 C42 B  92      26.861  37.341  38.013  1.00 10.00           C
ATOM     93 C529 C52 B  93      28.293  38.538  38.529  1.00 10.00           C
ATOM     94 C582 C58 B  94      38.023  39.113  28.411  1.00 10.00           C
ATOM     95 C668 C66 B  95      29.887  42.057  31.808  1.00 10.00           C
ATOM     96 C723 C72 B  96      32.444  35.983  39.863  1.00 10.00           C
ATOM     97 C768 C76 B  97      31.115  35.932  39.544  1.00 10.00           C
ATOM     98 C769 C76 B  98      28.432  32.575  32.863  1.00 10.00           C
ATOM     99 C801 C80 B  99      37.328  37.929  37.262  1.00 10.00           C
ATOM    100 C829 C82 B 100      28.253  38.788  30.817  1.00 10.00           C
ATOM    101 C845 C84 B 101      32.768  42.264  29.640  1.00 10.00           C
ATOM    102 C900 C90 B 102      34.709  34.813  34.484  1.00 10.00           C
ATOM    103 C959 C95 B 103      27.904  35.662  29.528  1.00 10.00           C
ATOM    104 C978 C97 B 104      33.099  36.686  42.637  1.00 10.00           C
ATOM    105 C104 C10 B 105      31.215  29.938  37.026  1.00 10.00           C
ATOM    106 C107 C10 B 106      29.140  27.448  33.823  1.00 10.00           C
ATOM    107 C109 C10 B 107      37.069  36.547  35.076  1.00 10.00           C
ATOM    108 C113 C11 B 108      38.293  30.877  39.124  1.00 10.00           C
ATOM    109 C114 C11 B 109      29.026  32.506  35.911  1.00 10.00           C
ATOM    110 C129 C12 B 110      39.757  29.077  41.056  1.00 10.00           C
ATOM    111 C129 C12 B 111      43.550  37.468  38.518  1.00 10.00           C
ATOM    112 C130 C13 B 112      37.347  37.859  33.007  1.00 10.00           C
ATOM    113 C134 C13 B 113      37.419  32.988  34.522  1.00 10.00           C
ATOM    114 C152 C15 B 114      39.483  31.715  39.312  1.00 10.00           C
ATOM    115 C153 C15 B 115      42.829  32.119  30.194  1.00 10.00           C
ATOM    116 C154 C15 B 116      36.459  33.081  36.736  1.00 10.00           C
ATOM    117 C164 C16 B 117      30.025  40.693  34.605  1.00 10.00           C
ATOM    118 C167 C16 B 118      34.148  40.365  27.467  1.00 10.00           C
ATOM    119 C168 C16 B 119      26.283  37.765  31.917  1.00 10.00           C
ATOM    120 C169 C16 B 120      42.667  32.789  30.295  1.00 10.00           C
ATOM    121 C174 C17 B 121      34.900  35.211  41.474  1.00 10.00           C
ATOM    122 C177 C17 B 122      32.635  30.229  37.725  1.00 10.00           C
ATOM    123 C178 C17 B 123      40.802  32.723  32.102  1.00 10.00           C
ATOM    124 C183 C18 B 124      39.141  38.331  41.304  1.00 10.00           C
ATOM    125 C186 C18 B 125      42.180  29.808  35.482  1.00 10.00           C
ATOM    126 C187 C18 B 126      30.114  40.219  35.549  1.00 10.00           C
ATOM    127 C189 C18 B 127      34.226  40.324  40.430  1.00 10.00           C
ATOM    128 C190 C19 B 128      37.965  34.425  28.051  1.00 10.00           C
ATOM    129 C192 C19 B 129      42.474  31.093  29.805  1.00 10.00           C
ATOM    130 C195 C19 B 130      33.531  29.343  37.877  1.00 10.00           C
ATOM    131 C216 C21 B 131      39.551  39.659  38.914  1.00 10.00           C
ATOM    132 C221 C22 B 132      36.337  39.669  34.530  1.00 10.00           C
ATOM    133 C226 C22 B 133      34.926  31.956  38.486  1.00 10.00           C
ATOM    134 C229 C22 B 134      38.462  43.513  35.977  1.00 10.00           C
ATOM    135 C234 C23 B 135      31.116  30.554  37.349  1.00 10.00           C
ATOM    136 C237 C23 B 136      34.351  42.459  38.689  1.00 10.00           C
ATOM    137 C247 C24 B 137      29.124  39.949  30.491  1.00 10.00           C
ATOM    138 C250 C25 B 138      38.685  26.810  31.498  1.00 10.00           C
ATOM    139 C253 C25 B 139      42.268  35.617  38.058  1.00 10.00           C
ATOM    140 C254 C25 B 140      28.427  40.009  35.866  1.00 10.00           C
ATOM    141 C259 C25 B 141      36.008  34.421  25.304  1.00 10.00           C
ATOM    142 C262 C26 B 142      41.377  41.667  34.493  1.00 10.00           C
ATOM    143 C264 C26 B 143      26.663  37.699  32.667  1.00 10.00           C
ATOM    144 C269 C26 B 144      28.338  32.857  37.481  1.00 10.00           C
ATOM    145 C271 C27 B 145      27.528  29.055  37.551  1.00 10.00           C
ATOM    146 C273 C27 B 146      31.120  35.992  40.789  1.00 10.00           C
ATOM    147 C279 C27 B 147      39.481  28.047  40.065  1.00 10.00           C
ATOM    148 C285 C28 B 148      38.889  27.743  30.573  1.00 10.00           C
ATOM    149 C295 C29 B 149      40.462  40.469  31.743  1.00 10.00           C
ATOM    150 C304 C30 B 150      33.301  30.090  30.476  1.00 10.00           C
ATOM    151 C304 C30 B 151      33.555  29.995  42.492  1.00 10.00           C
ATOM    152 C307 C30 B 152      33.756  25.734  31.851  1.00 10.00           C
ATOM    153 C309 C30 B 153      29.872  30.453  32.924  1.00 10.00           C
ATOM    154 C316 C31 B 154      37.332  36.931  37.429  1.00 10.00           C
ATOM    155 C316 C31 B 155      32.770  31.785  40.827  1.00 10.00           C
ATOM    156 C336 C33 B 156      37.261  30.736  37.374  1.00 10.00           C
ATOM    157 C337 C33 B 157      41.660  31.547  40.571  1.00 10.00           C
ATOM    158 C344 C34 B 158      40.151  40.979  40.322  1.00 10.00           C
ATOM    159 C345 C34 B 159      29.859  32.927  30.489  1.00 10.00           C
ATOM    160 C348 C34 B 160      34.932  40.232  32.328  1.00 10.00           C
ATOM    161 C357 C35 B 161      29.397  31.236  28.318  1.00 10.00           C
ATOM    162 C358 C35 B 162      34.835  36.804  31.213  1.00 10.00           C
ATOM    163 C364 C36 B 163      33.884  35.082  44.689  1.00 10.00           C
ATOM    164 C366 C36 B 164      38.641  30.324  37.243  1.00 10.00           C
ATOM    165 C376 C37 B 165      33.924  36.809  31.882  1.00 10.00           C
ATOM    166 C392 C39 B 166      30.296  37.566  41.662  1.00 10.00           C
ATOM    167 C395 C39 B 167      25.391  36.860  35.395  1.00 10.00           C
ATOM    168 C399 C39 B 168      32.386  34.327  39.741  1.00 10.00           C
TER
END
"""

def run(reflections_per_bin=250):
  #
  # Read PDB file from string above, create xray_structure object
  #
  pdb_inp = iotbx.pdb.input(source_info=None, lines=pdb_str)
  pdb_inp.write_pdb_file(file_name="model.pdb")
  xray_structure = pdb_inp.xray_structure_simple()
  #
  # Calculate "Fobs" from this model
  #
  f_obs = abs(xray_structure.structure_factors(d_min=2.0).f_calc())
  #
  o = tncs.compute_eps_factor(
    f_obs               = f_obs,
    pdb_hierarchy       = pdb_inp.construct_hierarchy(),
    reflections_per_bin = reflections_per_bin)
  o.show_summary()

if (__name__ == "__main__"):
  run()
